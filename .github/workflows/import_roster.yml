name: Import Roster Site (WO/Export)
on:
  workflow_dispatch: {}
  schedule:
    - cron: "*/10 * * * *"

permissions:
  contents: write

jobs:
  build_import:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Cache pip packages
        uses: actions/cache@v3
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('requirements.txt') }}

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Check if Import Excel file changed
        id: check_import_changes
        env:
          IMPORT_SOURCE_NAME_URL: ${{ secrets.IMPORT_SOURCE_NAME_URL }}
        run: |
          python << 'EOF'
          import os
          import base64
          import requests
          from pathlib import Path
          import sys
          from datetime import datetime, timezone, timedelta
          from urllib.parse import urlparse, parse_qsl, urlencode, urlunparse

          def candidate_urls(url):
              """نفس استراتيجيات التحميل الموجودة في generate_and_send_import.py"""
              candidates = []
              u = urlparse(url)
              host = (u.netloc or "").lower()
              is_sp = "sharepoint.com" in host
              is_od = "onedrive.live.com" in host or "1drv.ms" in host
              if not (is_sp or is_od):
                  return [url]
              # Strategy 1: OneDrive Sharing API
              encoded = base64.b64encode(url.encode("utf-8")).decode("utf-8")
              encoded = encoded.rstrip("=").replace("/", "_").replace("+", "-")
              candidates.append(f"https://api.onedrive.com/v1.0/shares/u!{encoded}/root/content")
              # Strategy 2: ?download=1
              qs = dict(parse_qsl(u.query, keep_blank_values=True))
              qs["download"] = "1"
              u2 = u._replace(query=urlencode(qs, doseq=True))
              candidates.append(urlunparse(u2))
              # Strategy 3: /p/ → /s/
              new_path = u.path.replace("/:x:/p/", "/:x:/s/").replace("/:t:/p/", "/:t:/s/")
              if new_path != u.path:
                  u3 = u._replace(path=new_path, query=urlencode(qs, doseq=True))
                  candidates.append(urlunparse(u3))
              # Strategy 4: original
              candidates.append(url)
              return candidates

          def fetch_source_name(url):
              """تحميل source_name.txt مع التحقق أن المحتوى نص وليس HTML"""
              headers = {"User-Agent": "Mozilla/5.0 (GitHub Actions) roster-site"}
              for i, dl_url in enumerate(candidate_urls(url), 1):
                  try:
                      print(f"  [Strategy {i}] {dl_url[:80]}...")
                      r = requests.get(dl_url, headers=headers, timeout=15, allow_redirects=True)
                      r.raise_for_status()
                      text = r.text.strip()
                      # تحقق أن المحتوى ليس HTML
                      if text and not text.startswith("<!") and "<html" not in text.lower()[:100]:
                          print(f"  ✅ Strategy {i} succeeded: {text}")
                          return text
                      print(f"  ⚠️  Strategy {i} got HTML — trying next...")
                  except Exception as e:
                      print(f"  ⚠️  Strategy {i} failed: {e}")
              return None

          def main():
              try:
                  source_url = os.getenv('IMPORT_SOURCE_NAME_URL')
                  if not source_url:
                      print("IMPORT_SOURCE_NAME_URL not found")
                      sys.exit(1)

                  print(f"Checking: {source_url[:60]}...")
                  current_filename = fetch_source_name(source_url)

                  if not current_filename:
                      print("❌ Could not fetch source_name.txt from any strategy")
                      sys.exit(1)

                  print(f"Current file: {current_filename}")

                  cache_file = "import_last_filename.txt"
                  changed = True
                  old_filename = "none"

                  if Path(cache_file).exists():
                      with open(cache_file, 'r', encoding='utf-8') as f:
                          old_filename = f.read().strip()
                      if old_filename:
                          print(f"Previous file: {old_filename}")
                          if old_filename == current_filename:
                              print("No changes detected")
                              changed = False
                          else:
                              print(f"Change detected: {old_filename} -> {current_filename}")
                  else:
                      print("First run")

                  with open(cache_file, 'w', encoding='utf-8') as f:
                      f.write(current_filename)

                  # Muscat time (UTC+4)
                  muscat_tz = timezone(timedelta(hours=4))
                  now = datetime.now(muscat_tz)
                  print(f"Muscat time: {now.strftime('%H:%M')}")

                  mandatory_update_hours = [0, 5, 6, 13, 14, 20, 21]
                  is_mandatory_update = (now.hour in mandatory_update_hours)
                  should_process = changed or is_mandatory_update

                  print(f"File changed: {changed}")
                  print(f"Mandatory update hour: {is_mandatory_update}")
                  print(f"Should process: {should_process}")

                  # تنظيف اسم الملف من أي أحرف تسبب مشكلة في GITHUB_OUTPUT
                  safe_filename = current_filename.replace('\n', ' ').replace('\r', '').strip()
                  safe_old = old_filename.replace('\n', ' ').replace('\r', '').strip()

                  with open(os.environ['GITHUB_OUTPUT'], 'a') as f:
                      f.write(f"changed={str(changed).lower()}\n")
                      f.write(f"should_process={str(should_process).lower()}\n")
                      f.write(f"filename={safe_filename}\n")
                      f.write(f"old_filename={safe_old}\n")

                  print("=" * 60)
                  print(f"  File changed:     {changed}")
                  print(f"  Mandatory update: {is_mandatory_update}")
                  print(f"  Should process:   {should_process}")
                  print("=" * 60)

              except requests.exceptions.Timeout:
                  print("Connection timeout")
                  sys.exit(1)
              except requests.exceptions.RequestException as e:
                  print(f"Request error: {e}")
                  sys.exit(1)
              except Exception as e:
                  print(f"Unexpected error: {e}")
                  import traceback
                  traceback.print_exc()
                  sys.exit(1)

          if __name__ == "__main__":
              main()
          EOF

      - name: Display change info
        run: |
          echo "========================================"
          echo "Import Check Report:"
          echo "========================================"
          echo "File changed:   ${{ steps.check_import_changes.outputs.changed }}"
          echo "Should process: ${{ steps.check_import_changes.outputs.should_process }}"
          echo "Current file:   ${{ steps.check_import_changes.outputs.filename }}"
          echo "Previous file:  ${{ steps.check_import_changes.outputs.old_filename }}"
          echo "========================================"

      - name: Generate Import pages
        if: steps.check_import_changes.outputs.should_process == 'true'
        env:
          IMPORT_EXCEL_URL: ${{ secrets.IMPORT_EXCEL_URL }}
          IMPORT_SOURCE_NAME_URL: ${{ secrets.IMPORT_SOURCE_NAME_URL }}
          PAGES_BASE_URL: ${{ secrets.PAGES_BASE_URL }}
        run: |
          echo "Generating /docs/import ..."
          python generate_and_send_import.py
          echo "Done!"

      - name: Commit updated Import docs
        if: steps.check_import_changes.outputs.should_process == 'true'
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git add docs/import import_last_filename.txt
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            if [ "${{ steps.check_import_changes.outputs.changed }}" == "true" ]; then
              git commit -m "Update IMPORT roster: ${{ steps.check_import_changes.outputs.filename }}"
            else
              git commit -m "Scheduled IMPORT update"
            fi
            git pull --rebase
            git push
            echo "Pushed!"
          fi

      - name: Skip - No action needed
        if: steps.check_import_changes.outputs.should_process == 'false'
        run: |
          echo "========================================"
          echo "No action needed"
          echo "Current file: ${{ steps.check_import_changes.outputs.filename }}"
          echo "========================================"
