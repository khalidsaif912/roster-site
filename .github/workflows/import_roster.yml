name: Import Roster Site (WO/Export)

on:
  workflow_dispatch: {}
  schedule:
    - cron: "*/10 * * * *"

permissions:
  contents: write

jobs:
  build_import:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests

      - name: Check if Import Excel OR source_name changed
        id: check_import_changes
        env:
          IMPORT_EXCEL_URL: ${{ secrets.IMPORT_EXCEL_URL }}
          IMPORT_SOURCE_NAME_URL: ${{ secrets.IMPORT_SOURCE_NAME_URL }}
        run: |
          python << 'EOF'
          import os
          import base64
          import hashlib
          import requests
          from pathlib import Path
          import sys
          from urllib.parse import urlparse, parse_qsl, urlencode, urlunparse

          def candidate_urls(url):
              candidates = []
              u = urlparse(url)
              host = (u.netloc or "").lower()
              if not ("sharepoint.com" in host or "onedrive.live.com" in host or "1drv.ms" in host):
                  return [url]
              encoded = base64.b64encode(url.encode("utf-8")).decode("utf-8")
              encoded = encoded.rstrip("=").replace("/", "_").replace("+", "-")
              candidates.append(f"https://api.onedrive.com/v1.0/shares/u!{encoded}/root/content")
              qs = dict(parse_qsl(u.query, keep_blank_values=True))
              qs["download"] = "1"
              candidates.append(urlunparse(u._replace(query=urlencode(qs, doseq=True))))
              candidates.append(url)
              return candidates

          def download_excel(url):
              headers = {
                  "User-Agent": "Mozilla/5.0 (GitHub Actions)",
                  "Accept": "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet,*/*",
              }
              for dl_url in candidate_urls(url):
                  try:
                      r = requests.get(dl_url, headers=headers, timeout=60)
                      r.raise_for_status()
                      data = r.content or b""
                      if data.startswith(b"PK"):
                          return data
                  except:
                      pass
              return None

          def download_text(url):
              try:
                  r = requests.get(url, timeout=30)
                  r.raise_for_status()
                  return r.text.strip()
              except:
                  return ""

          def main():
              excel_url = os.getenv("IMPORT_EXCEL_URL")
              source_url = os.getenv("IMPORT_SOURCE_NAME_URL")

              if not excel_url:
                  print("Missing IMPORT_EXCEL_URL")
                  sys.exit(1)

              excel_data = download_excel(excel_url)
              if not excel_data:
                  print("Failed to download Excel")
                  sys.exit(1)

              source_text = download_text(source_url) if source_url else ""

              combined = excel_data + source_text.encode("utf-8")
              current_hash = hashlib.md5(combined).hexdigest()

              cache_file = "import_last_filename.txt"
              old_hash = ""

              if Path(cache_file).exists():
                  old_hash = Path(cache_file).read_text().strip()

              changed = current_hash != old_hash
              should_process = changed

              print("====================================")
              print(f"Old hash: {old_hash}")
              print(f"New hash: {current_hash}")
              print(f"Changed:  {changed}")
              print("====================================")

              Path(cache_file).write_text(current_hash)

              with open(os.environ["GITHUB_OUTPUT"], "a") as f:
                  f.write(f"changed={str(changed).lower()}\n")
                  f.write(f"should_process={str(should_process).lower()}\n")

          if __name__ == "__main__":
              main()
          EOF

      - name: Generate Import pages
        if: steps.check_import_changes.outputs.should_process == 'true'
        env:
          IMPORT_EXCEL_URL: ${{ secrets.IMPORT_EXCEL_URL }}
          IMPORT_SOURCE_NAME_URL: ${{ secrets.IMPORT_SOURCE_NAME_URL }}
        run: |
          echo "Generating /docs/import ..."
          python generate_and_send_import.py
          echo "Done!"

      - name: Commit changes
        if: steps.check_import_changes.outputs.should_process == 'true'
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git add docs/import import_last_filename.txt
          if git diff --staged --quiet; then
            echo "No changes"
          else
            git commit -m "Update IMPORT roster"
            git pull --rebase
            git push
          fi

      - name: Skip - No change detected
        if: steps.check_import_changes.outputs.should_process == 'false'
        run: |
          echo "No update needed."
