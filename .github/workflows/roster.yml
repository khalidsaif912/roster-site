name: Roster Site + Email
on:
  workflow_dispatch: {}
  schedule:
    - cron: "0 */2 * * *"  # ÙƒÙ„ Ø³Ø§Ø¹ØªÙŠÙ† (ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„)

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      
      # ØªØ³Ø±ÙŠØ¹ Ø§Ù„ØªØ«Ø¨ÙŠØª Ø¨Ø­ÙØ¸ Ø§Ù„Ù…ÙƒØªØ¨Ø§Øª
      - name: Cache pip packages
        uses: actions/cache@v3
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('requirements.txt') }}
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      # âœ… Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØªØºÙŠÙŠØ± Ø§Ø³Ù… Ø§Ù„Ù…Ù„Ù
      - name: Check if Excel file changed
        id: check_changes
        env:
          SOURCE_NAME_URL: ${{ secrets.SOURCE_NAME_URL }}
        run: |
          python << 'EOF'
          import os
          import requests
          from pathlib import Path
          import sys
          
          def main():
              try:
                  # Ù‚Ø±Ø§Ø¡Ø© Ø§Ø³Ù… Ø§Ù„Ù…Ù„Ù Ù…Ù† Ø§Ù„Ø±Ø§Ø¨Ø·
                  source_url = os.getenv('SOURCE_NAME_URL')
                  
                  if not source_url:
                      print("âŒ Ø®Ø·Ø£: SOURCE_NAME_URL ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ Secrets")
                      sys.exit(1)
                  
                  print(f"ğŸ”— Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù†: {source_url}")
                  response = requests.get(source_url, timeout=15)
                  response.raise_for_status()
                  
                  current_filename = response.text.strip()
                  
                  if not current_filename:
                      print("âŒ Ø®Ø·Ø£: Ù…Ù„Ù source_name.txt ÙØ§Ø±Øº")
                      sys.exit(1)
                  
                  print(f"ğŸ“„ Ø§Ø³Ù… Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø­Ø§Ù„ÙŠ: {current_filename}")
                  
                  # Ù…Ù‚Ø§Ø±Ù†Ø© Ù…Ø¹ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø³Ø§Ø¨Ù‚
                  cache_file = "last_filename.txt"
                  changed = True
                  old_filename = "Ù„Ø§ ÙŠÙˆØ¬Ø¯"
                  
                  if Path(cache_file).exists():
                      with open(cache_file, 'r', encoding='utf-8') as f:
                          old_filename = f.read().strip()
                      
                      if old_filename:
                          print(f"ğŸ“„ Ø§Ø³Ù… Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø³Ø§Ø¨Ù‚: {old_filename}")
                          
                          if old_filename == current_filename:
                              print("âœ… Ù„Ø§ ØªÙˆØ¬Ø¯ ØªØºÙŠÙŠØ±Ø§Øª - Ù†ÙØ³ Ø§Ù„Ù…Ù„Ù")
                              changed = False
                          else:
                              print(f"ğŸ”„ ØªÙ… Ø§ÙƒØªØ´Ø§Ù ØªØºÙŠÙŠØ± ÙÙŠ Ø§Ù„Ù…Ù„Ù!")
                              print(f"   ğŸ“Œ Ø§Ù„Ù‚Ø¯ÙŠÙ…: {old_filename}")
                              print(f"   ğŸ“Œ Ø§Ù„Ø¬Ø¯ÙŠØ¯: {current_filename}")
                  else:
                      print("ğŸ†• Ø£ÙˆÙ„ ØªØ´ØºÙŠÙ„ - Ø³ÙŠØªÙ… Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ù…Ù„Ù")
                  
                  # Ø­ÙØ¸ Ø§Ø³Ù… Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø¬Ø¯ÙŠØ¯
                  with open(cache_file, 'w', encoding='utf-8') as f:
                      f.write(current_filename)
                  
                  print(f"ğŸ’¾ ØªÙ… Ø­ÙØ¸ Ø§Ø³Ù… Ø§Ù„Ù…Ù„Ù ÙÙŠ {cache_file}")
                  
                  # Ø¥Ø®Ø±Ø§Ø¬ Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ù„Ù€ GitHub Actions
                  with open(os.environ['GITHUB_OUTPUT'], 'a') as f:
                      f.write(f"changed={str(changed).lower()}\n")
                      f.write(f"filename={current_filename}\n")
                      f.write(f"old_filename={old_filename}\n")
                  
                  print(f"\n{'='*60}")
                  print(f"ğŸ“Š Ø§Ù„Ù†ØªÙŠØ¬Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©: changed = {changed}")
                  print(f"{'='*60}\n")
                  
              except requests.exceptions.Timeout:
                  print("âŒ Ø§Ù†ØªÙ‡Øª Ù…Ù‡Ù„Ø© Ø§Ù„Ø§ØªØµØ§Ù„ - Ø§Ù„Ø±Ø§Ø¨Ø· Ø¨Ø·ÙŠØ¡ Ø¬Ø¯Ø§Ù‹")
                  sys.exit(1)
              except requests.exceptions.RequestException as e:
                  print(f"âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø±Ø§Ø¨Ø·: {e}")
                  sys.exit(1)
              except Exception as e:
                  print(f"âŒ Ø®Ø·Ø£ ØºÙŠØ± Ù…ØªÙˆÙ‚Ø¹: {e}")
                  import traceback
                  traceback.print_exc()
                  sys.exit(1)
          
          if __name__ == "__main__":
              main()
          EOF
      
      # âœ… Ø¹Ø±Ø¶ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ØªØºÙŠÙŠØ±
      - name: Display change info
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“Š ØªÙ‚Ø±ÙŠØ± Ø§Ù„ÙØ­Øµ:"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âœ“ Ù‡Ù„ ØªØºÙŠØ± Ø§Ù„Ù…Ù„ÙØŸ ${{ steps.check_changes.outputs.changed }}"
          echo "âœ“ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø­Ø§Ù„ÙŠ: ${{ steps.check_changes.outputs.filename }}"
          echo "âœ“ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø³Ø§Ø¨Ù‚: ${{ steps.check_changes.outputs.old_filename }}"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
      
      # âœ… Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ù…Ù„Ù ÙÙ‚Ø· Ø¹Ù†Ø¯ Ø§Ù„ØªØºÙŠÙŠØ±
      - name: Generate page + send email
        if: steps.check_changes.outputs.changed == 'true'
        env:
          EXCEL_URL: ${{ secrets.EXCEL_URL }}
          SOURCE_NAME_URL: ${{ secrets.SOURCE_NAME_URL }}
          PAGES_BASE_URL: ${{ secrets.PAGES_BASE_URL }}
          SMTP_HOST: ${{ secrets.SMTP_HOST }}
          SMTP_PORT: ${{ secrets.SMTP_PORT }}
          SMTP_USER: ${{ secrets.SMTP_USER }}
          SMTP_PASS: ${{ secrets.SMTP_PASS }}
          MAIL_FROM: ${{ secrets.MAIL_FROM }}
          MAIL_TO: ${{ secrets.MAIL_TO }}
          SUBSCRIBE_URL: ${{ secrets.SUBSCRIBE_URL }}
          SUBSCRIBE_TOKEN: ${{ secrets.SUBSCRIBE_TOKEN }}
        run: |
          echo "ğŸ”„ Ø¨Ø¯Ø¡ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ù…Ù„Ù: ${{ steps.check_changes.outputs.filename }}"
          python generate_and_send.py
          echo "âœ… Ø§ÙƒØªÙ…Ù„Øª Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø© Ø¨Ù†Ø¬Ø§Ø­"
      
      # âœ… Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª
      - name: Commit updated docs
        if: steps.check_changes.outputs.changed == 'true'
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git add docs last_filename.txt
          if git diff --staged --quiet; then
            echo "âš ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ ØªØºÙŠÙŠØ±Ø§Øª Ù„Ù„Ø­ÙØ¸"
          else
            git commit -m "ğŸ“ Update roster: ${{ steps.check_changes.outputs.filename }}"
            git push
            echo "âœ… ØªÙ… Ø±ÙØ¹ Ø§Ù„ØªØ­Ø¯ÙŠØ«Ø§Øª Ø¥Ù„Ù‰ GitHub"
          fi
      
      # âœ… Ø±Ø³Ø§Ù„Ø© Ø¹Ù†Ø¯ Ø¹Ø¯Ù… ÙˆØ¬ÙˆØ¯ ØªØºÙŠÙŠØ±Ø§Øª
      - name: Skip - No changes detected
        if: steps.check_changes.outputs.changed == 'false'
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âœ… Ù„Ø§ ØªÙˆØ¬Ø¯ ØªØºÙŠÙŠØ±Ø§Øª ÙÙŠ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“„ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø­Ø§Ù„ÙŠ: ${{ steps.check_changes.outputs.filename }}"
          echo "â­ï¸  ØªÙ… ØªØ®Ø·ÙŠ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø© ÙˆØ§Ù„Ø¥ÙŠÙ…ÙŠÙ„"
          echo "ğŸ’¾ ØªÙ… ØªÙˆÙÙŠØ± Ø§Ù„ÙˆÙ‚Øª ÙˆØ§Ù„Ù…ÙˆØ§Ø±Ø¯"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
