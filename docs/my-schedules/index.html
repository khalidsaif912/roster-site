<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <title>My Schedule</title>
  <style>
    *{box-sizing:border-box;margin:0;padding:0}
    :root{
      --bg:#f0f4ff;--card:#fff;--text:#0f172a;--muted:#64748b;
      --border:#e5e7eb;--b1:#1e73ff;--b2:#00b3ff;--b3:#2b59ff;--r:14px;
    }
    body{
      font-family:'Segoe UI',system-ui,sans-serif;
      background:radial-gradient(ellipse 120% 40% at 50% 0%,rgba(30,115,255,.15),transparent 60%),
                 linear-gradient(180deg,var(--bg),#fff 70%);
      min-height:100vh;padding:8px;color:var(--text);font-size:14px;
    }
    .wrap{max-width:520px;margin:0 auto;display:flex;flex-direction:column;gap:8px}

    .hero{
      background:linear-gradient(135deg,var(--b3),var(--b2));
      border-radius:var(--r);padding:11px 13px;position:relative;overflow:hidden;
    }
    .hero::before{
      content:"";position:absolute;top:-40px;right:-40px;
      width:130px;height:130px;border-radius:50%;background:rgba(255,255,255,.12);
    }
    .hero-row{position:relative;display:flex;align-items:center;justify-content:space-between;gap:8px}
    .brand{display:flex;align-items:center;gap:9px}
    .logo{
      width:36px;height:36px;border-radius:10px;
      background:rgba(255,255,255,.22);border:1px solid rgba(255,255,255,.25);
      display:flex;align-items:center;justify-content:center;font-size:17px;flex-shrink:0;
    }
    .brand-text h1{color:#fff;font-size:15px;font-weight:800;line-height:1.2}
    .brand-text p{color:rgba(255,255,255,.85);font-size:11px;font-weight:600}
    .hero-btns{display:flex;gap:6px;align-items:center}
    .lang-btn,.back-btn{
      background:rgba(255,255,255,.18);border:1px solid rgba(255,255,255,.3);
      color:#fff;border-radius:8px;padding:5px 10px;
      font-size:11px;font-weight:700;cursor:pointer;transition:background .2s;white-space:nowrap;
    }
    .lang-btn:hover,.back-btn:hover{background:rgba(255,255,255,.3)}

    .card{
      background:var(--card);border-radius:var(--r);
      box-shadow:0 4px 20px rgba(2,6,23,.07);border:1px solid var(--border);overflow:hidden;
    }
    .search-area{
      padding:10px 12px;background:linear-gradient(180deg,#fff,#fbfcff);
      border-bottom:1px solid var(--border);
    }
    .search-row{display:flex;gap:7px}
    .search-input{
      flex:1;min-width:0;padding:9px 12px;border:1.5px solid var(--border);
      border-radius:10px;font-size:14px;direction:ltr;background:#fff;
      transition:border-color .2s,box-shadow .2s;
    }
    .search-input:focus{outline:none;border-color:rgba(30,115,255,.7);box-shadow:0 0 0 3px rgba(30,115,255,.1)}
    .search-btn{
      padding:9px 14px;background:linear-gradient(135deg,var(--b3),var(--b2));
      color:#fff;border:none;border-radius:10px;font-size:13px;font-weight:800;
      cursor:pointer;transition:transform .2s,box-shadow .2s;white-space:nowrap;
    }
    .search-btn:hover{transform:translateY(-1px);box-shadow:0 6px 18px rgba(30,115,255,.28)}

    .content{padding:10px}
    .empty-state{text-align:center;padding:30px 16px;color:var(--muted)}
    .empty-icon{font-size:38px;margin-bottom:8px}
    .empty-state h3{font-size:15px;margin-bottom:4px;color:var(--text)}
    .empty-state p{font-size:12px}

    .emp-bar{
      background:linear-gradient(135deg,var(--b3),var(--b2));color:#fff;
      border-radius:10px;padding:9px 11px;margin-bottom:8px;
      display:flex;align-items:center;justify-content:space-between;gap:8px;
      box-shadow:0 4px 14px rgba(30,115,255,.2);
    }
    .emp-info h2{font-size:14px;font-weight:800;line-height:1.3}
    .emp-info p{font-size:11px;opacity:.9;margin-top:2px}
    .month-nav{display:flex;align-items:center;gap:6px;flex-shrink:0}
    .month-nav button{
      width:30px;height:30px;border-radius:50%;
      background:rgba(255,255,255,.18);border:1px solid rgba(255,255,255,.25);
      color:#fff;font-size:15px;cursor:pointer;transition:background .2s;
      display:flex;align-items:center;justify-content:center;
    }
    .month-nav button:hover{background:rgba(255,255,255,.3)}
    .month-nav span{font-size:12px;font-weight:800;min-width:86px;text-align:center}

    /* CALENDAR */
    .calendar{
      background:#fff;border-radius:10px;border:1px solid var(--border);
      overflow:hidden;margin-bottom:8px;
    }
    .cal-head{
      display:grid;grid-template-columns:repeat(7,1fr);
      background:#f8fafc;border-bottom:1.5px solid var(--border);
    }
    .cal-head div{padding:7px 2px;text-align:center;font-weight:800;color:#475569;font-size:10px}
    .cal-body{display:grid;grid-template-columns:repeat(7,1fr)}

    .cal-day{
      border:1px solid #f0f0f0;padding:4px 2px;background:#fff;
      min-height:54px;display:flex;flex-direction:column;align-items:center;
    }
    .cal-day.empty{background:#fafafa}
    .cal-day.today{box-shadow:inset 0 0 0 2px var(--b1);background:#f0f6ff}

    /* coloured top strip per shift â€” no text at all */
    .cal-day.s-morning  {border-top:3px solid #f59e0b}
    .cal-day.s-afternoon{border-top:3px solid #f97316}
    .cal-day.s-night    {border-top:3px solid #7c3aed}
    .cal-day.s-off      {border-top:3px solid #94a3b8}
    .cal-day.s-leave    {border-top:3px solid #22c55e}
    .cal-day.s-training {border-top:3px solid #3b82f6}
    .cal-day.s-standby  {border-top:3px solid #ec4899}
    .cal-day.s-other    {border-top:3px solid #9ca3af}

    .d-num{font-size:12px;font-weight:900;color:#0f172a;margin-bottom:1px;margin-top:1px}
    .d-icon{font-size:16px;line-height:1;margin:2px 0}
    .d-code{font-size:9px;color:var(--muted);font-weight:800;margin-top:2px;background:#f1f5f9;border-radius:4px;padding:1px 4px}

    /* LEGEND */
    .legend{display:flex;flex-wrap:wrap;gap:5px;margin-bottom:8px}
    .leg-item{display:flex;align-items:center;gap:4px;font-size:10px;font-weight:700;color:var(--muted)}
    .leg-dot{width:10px;height:10px;border-radius:3px;flex-shrink:0}

    /* STATS */
    .stats{background:#f8fafc;border-radius:10px;border:1px solid var(--border);padding:8px;margin-bottom:8px}
    .stats-title{font-size:10px;font-weight:800;color:var(--muted);margin-bottom:6px;text-transform:uppercase;letter-spacing:.5px}
    .stats-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:4px}
    @media(max-width:380px){.stats-grid{grid-template-columns:repeat(4,1fr)}}
    .stat-box{background:#fff;border:1px solid var(--border);border-radius:7px;padding:6px 4px;text-align:center}
    .stat-lbl{font-size:9px;color:var(--muted);font-weight:700;margin-bottom:3px}
    .stat-val{font-size:17px;font-weight:900;color:var(--text);line-height:1}

    /* ACTIONS */
    .actions{display:grid;grid-template-columns:repeat(2,1fr);gap:5px}
    .act-btn{
      padding:8px 6px;border:1.5px solid var(--border);background:#fff;
      border-radius:9px;font-size:11px;font-weight:800;cursor:pointer;transition:all .2s;
      display:flex;align-items:center;justify-content:center;gap:5px;white-space:nowrap;
    }
    .act-btn:hover{border-color:rgba(30,115,255,.5);color:var(--b1);transform:translateY(-1px)}
    .act-primary{background:linear-gradient(135deg,var(--b3),var(--b2));color:#fff;border-color:transparent}
    .act-primary:hover{color:#fff;border-color:transparent;box-shadow:0 6px 18px rgba(30,115,255,.26)}
    .act-ics{background:#f0fdf4;border-color:#86efac;color:#166534}
    .act-ics:hover{background:#dcfce7;border-color:#4ade80;color:#166534;transform:translateY(-1px)}

    .loading{text-align:center;padding:30px 16px;color:var(--muted)}
    .spinner{width:32px;height:32px;border:3px solid #e5e7eb;border-top-color:var(--b1);border-radius:50%;animation:spin 1s linear infinite;margin:0 auto 10px}
    @keyframes spin{to{transform:rotate(360deg)}}
    .loading p{font-size:12px}

    @media print{
      body{background:#fff;padding:0}
      .hero,.search-area,.actions,.back-btn,.lang-btn{display:none!important}
      .wrap{max-width:100%}
    }
  </style>
</head>
<body>
<div class="wrap">

  <div class="hero">
    <div class="hero-row">
      <div class="brand">
        <div class="logo">ğŸ“…</div>
        <div class="brand-text">
          <h1 id="ttl">My Schedule</h1>
          <p id="sub">Enter your Employee ID to view schedule</p>
        </div>
      </div>
      <div class="hero-btns">
        <button class="lang-btn" onclick="toggleLang()">Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©</button>
        <button class="back-btn" onclick="goBack()">â† Back</button>
      </div>
    </div>
  </div>

  <div class="card">
    <div class="search-area">
      <form class="search-row" id="searchForm">
        <input type="text" class="search-input" id="empId"
          placeholder="Employee ID (e.g. 12345)" pattern="[0-9]+" required>
        <button type="submit" class="search-btn" id="sbtn">ğŸ“… View</button>
      </form>
    </div>
    <div class="content" id="area">
      <div class="empty-state">
        <div class="empty-icon">ğŸ”</div>
        <h3 id="e1">Search your schedule</h3>
        <p id="e2">Enter your Employee ID above</p>
      </div>
    </div>
  </div>

</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script>
let data=null,month=null,months=[],lang='en';

const COLORS={
  Morning:     {strip:'#f59e0b',icon:'â˜€ï¸'},
  Afternoon:   {strip:'#f97316',icon:'ğŸŒ¤ï¸'},
  Night:       {strip:'#7c3aed',icon:'ğŸŒ™'},
  'Off Day':   {strip:'#94a3b8',icon:'ğŸ›Œ'},
  'Annual Leave':{strip:'#22c55e',icon:'âœˆï¸'},
  'Sick Leave':{strip:'#22c55e',icon:'ğŸ¤’'},
  Training:    {strip:'#3b82f6',icon:'ğŸ“š'},
  Standby:     {strip:'#ec4899',icon:'ğŸ§'},
  Other:       {strip:'#9ca3af',icon:'â“'}
};

const T={
  en:{
    title:'My Schedule',sub:'Enter your Employee ID to view schedule',
    back:'â† Back',langBtn:'Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©',
    ph:'Employee ID (e.g. 12345)',sbtn:'ğŸ“… View',
    e1:'Search your schedule',e2:'Enter your Employee ID above',
    loading:'Loading...',notFound:'Employee not found',
    notFoundSub:'ID not in the system. Please check and try again.',
    statsTitle:'STATISTICS',
    workDays:'Work',offDays:'Off',morning:'â˜€ï¸',afternoon:'ğŸŒ¤ï¸',night:'ğŸŒ™',standby:'ğŸ§',leaves:'Leaves',
    pdf:'ğŸ“¥ PDF',share:'ğŸ”— Share',print:'ğŸ–¨ï¸ Print',ics:'ğŸ“† ICS',
    days:['Sun','Mon','Tue','Wed','Thu','Fri','Sat'],
    months:['January','February','March','April','May','June',
            'July','August','September','October','November','December'],
    legend:{Morning:'Morning',Afternoon:'Afternoon',Night:'Night',
            'Off Day':'Off','Annual Leave':'Leave','Sick Leave':'Sick',
            Training:'Training',Standby:'Standby',Other:'Other'}
  },
  ar:{
    title:'Ø¬Ø¯ÙˆÙ„ÙŠ',sub:'Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù…Ùƒ Ø§Ù„ÙˆØ¸ÙŠÙÙŠ Ù„Ø¹Ø±Ø¶ Ø§Ù„Ø¬Ø¯ÙˆÙ„',
    back:'Ø±Ø¬ÙˆØ¹ â†',langBtn:'English',
    ph:'Ø§Ù„Ø±Ù‚Ù… Ø§Ù„ÙˆØ¸ÙŠÙÙŠ (Ù…Ø«Ø§Ù„: 12345)',sbtn:'ğŸ“… Ø¹Ø±Ø¶',
    e1:'Ø§Ø¨Ø­Ø« Ø¹Ù† Ø¬Ø¯ÙˆÙ„Ùƒ',e2:'Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù…Ùƒ Ø§Ù„ÙˆØ¸ÙŠÙÙŠ Ø£Ø¹Ù„Ø§Ù‡',
    loading:'Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...',notFound:'Ù„Ù… ÙŠÙØ¹Ø«Ø± Ø¹Ù„Ù‰ Ù…ÙˆØ¸Ù',
    notFoundSub:'Ø§Ù„Ø±Ù‚Ù… ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯. ØªØ­Ù‚Ù‚ ÙˆØ£Ø¹Ø¯ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©.',
    statsTitle:'Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª',
    workDays:'Ø¹Ù…Ù„',offDays:'Ø¥Ø¬Ø§Ø²Ø©',morning:'â˜€ï¸',afternoon:'ğŸŒ¤ï¸',night:'ğŸŒ™',standby:'ğŸ§',leaves:'Ø³Ù†ÙˆÙŠØ©',
    pdf:'ğŸ“¥ PDF',share:'ğŸ”— Ù…Ø´Ø§Ø±ÙƒØ©',print:'ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø©',ics:'ğŸ“† ICS',
    days:['Ø§Ù„Ø£Ø­','Ø§Ù„Ø§Ø«','Ø§Ù„Ø«Ù„','Ø§Ù„Ø£Ø±','Ø§Ù„Ø®Ù…','Ø§Ù„Ø¬Ù…','Ø§Ù„Ø³Ø¨'],
    months:['ÙŠÙ†Ø§ÙŠØ±','ÙØ¨Ø±Ø§ÙŠØ±','Ù…Ø§Ø±Ø³','Ø£Ø¨Ø±ÙŠÙ„','Ù…Ø§ÙŠÙˆ','ÙŠÙˆÙ†ÙŠÙˆ',
            'ÙŠÙˆÙ„ÙŠÙˆ','Ø£ØºØ³Ø·Ø³','Ø³Ø¨ØªÙ…Ø¨Ø±','Ø£ÙƒØªÙˆØ¨Ø±','Ù†ÙˆÙÙ…Ø¨Ø±','Ø¯ÙŠØ³Ù…Ø¨Ø±'],
    legend:{Morning:'ØµØ¨Ø§Ø­ÙŠ',Afternoon:'Ù…Ø³Ø§Ø¦ÙŠ',Night:'Ù„ÙŠÙ„ÙŠ',
            'Off Day':'Ø¥Ø¬Ø§Ø²Ø©','Annual Leave':'Ø³Ù†ÙˆÙŠØ©','Sick Leave':'Ù…Ø±Ø¶ÙŠØ©',
            Training:'ØªØ¯Ø±ÙŠØ¨',Standby:'Ø§Ø­ØªÙŠØ§Ø·ÙŠ',Other:'Ø£Ø®Ø±Ù‰'}
  }
};

function t(k){return T[lang][k]}

function applyLangUI(){
  document.documentElement.lang=lang;
  document.documentElement.dir=lang==='ar'?'rtl':'ltr';
  document.getElementById('ttl').textContent=t('title');
  document.getElementById('sub').textContent=t('sub');
  document.querySelector('.back-btn').textContent=t('back');
  document.querySelector('.lang-btn').textContent=t('langBtn');
  document.getElementById('empId').placeholder=t('ph');
  document.getElementById('sbtn').textContent=t('sbtn');
  const e1=document.getElementById('e1'),e2=document.getElementById('e2');
  if(e1) e1.textContent=t('e1');
  if(e2) e2.textContent=t('e2');
  if(data) renderSchedule();
}
function toggleLang(){lang=lang==='en'?'ar':'en';applyLangUI()}

function goBack(){
  const base=location.pathname.includes('/roster-site/')?'/roster-site/':'/';
  if(document.referrer&&document.referrer.includes(location.host)) history.back();
  else location.href=base;
}

document.getElementById('searchForm').addEventListener('submit',async e=>{
  e.preventDefault();
  const id=document.getElementById('empId').value.trim();
  if(id) await loadSchedule(id);
});

async function loadSchedule(id){
  document.getElementById('area').innerHTML=
    `<div class="loading"><div class="spinner"></div><p>${t('loading')}</p></div>`;
  try{
    const res=await fetch(`../schedules/${id}.json`);
    if(!res.ok) throw new Error();
    data=await res.json();
    months=Object.keys(data.schedules).sort().reverse();
    if(!months.length) throw new Error();
    month=months[0];
    renderSchedule();
  }catch{
    document.getElementById('area').innerHTML=`
      <div class="empty-state">
        <div class="empty-icon">âŒ</div>
        <h3>${t('notFound')}</h3>
        <p>${t('notFoundSub')}</p>
      </div>`;
  }
}

function renderSchedule(){
  const sched=data.schedules[month];
  const [yr,mo]=month.split('-').map(Number);
  const mName=T[lang].months[mo-1];
  const ci=months.indexOf(month);
  const hasNext=ci>0,hasPrev=ci<months.length-1;

  const firstDow=new Date(yr,mo-1,1).getDay();
  const daysInMonth=new Date(yr,mo,0).getDate();
  const stats=calcStats(sched);

  /* Calendar cells: ICON + CODE only â€” zero text labels */
  let cells='',dc=1;
  for(let w=0;w<6;w++){
    for(let d=0;d<7;d++){
      if((w===0&&d<firstDow)||dc>daysInMonth){
        cells+='<div class="cal-day empty"></div>';
      }else{
        const dd=sched.find(s=>s.day===dc);
        const today=isToday(yr,mo,dc);
        if(dd){
          const sc=shiftClass(dd.shift_group);
          const icon=COLORS[dd.shift_group]?.icon||'â“';
          cells+=`<div class="cal-day ${sc}${today?' today':''}">
            <div class="d-num">${dc}</div>
            <div class="d-icon">${icon}</div>
            ${dd.shift_code?`<div class="d-code">${esc(dd.shift_code)}</div>`:''}
          </div>`;
        }else{
          cells+=`<div class="cal-day${today?' today':''}"><div class="d-num">${dc}</div></div>`;
        }
        dc++;
      }
    }
    if(dc>daysInMonth) break;
  }

  const dayHdr=T[lang].days.map(d=>`<div>${d}</div>`).join('');

  /* Legend */
  const used=[...new Set(sched.map(s=>s.shift_group))];
  const legHTML=used.map(g=>{
    const c=COLORS[g];if(!c) return '';
    return `<span class="leg-item"><span class="leg-dot" style="background:${c.strip}"></span>${T[lang].legend[g]||g}</span>`;
  }).join('');

  document.getElementById('area').innerHTML=`
    <div class="emp-bar">
      <div class="emp-info">
        <h2>${esc(data.name)}</h2>
        <p>ğŸ“‹ ${esc(data.department)} &nbsp;â€¢&nbsp; ğŸ†” ${esc(data.id)}</p>
      </div>
      <div class="month-nav">
        <button onclick="chMonth(-1)" ${!hasPrev?'disabled style="opacity:.35;cursor:default"':''}>&lt;</button>
        <span>${mName} ${yr}</span>
        <button onclick="chMonth(1)" ${!hasNext?'disabled style="opacity:.35;cursor:default"':''}>&gt;</button>
      </div>
    </div>

    <div class="calendar">
      <div class="cal-head">${dayHdr}</div>
      <div class="cal-body">${cells}</div>
    </div>

    <div class="legend">${legHTML}</div>

    <div class="stats">
      <div class="stats-title">${t('statsTitle')}</div>
      <div class="stats-grid">
        <div class="stat-box"><div class="stat-lbl">${t('workDays')}</div><div class="stat-val">${stats.work}</div></div>
        <div class="stat-box"><div class="stat-lbl">${t('offDays')}</div><div class="stat-val">${stats.off}</div></div>
        <div class="stat-box"><div class="stat-lbl">${t('morning')}</div><div class="stat-val">${stats.morning}</div></div>
        <div class="stat-box"><div class="stat-lbl">${t('afternoon')}</div><div class="stat-val">${stats.afternoon}</div></div>
        <div class="stat-box"><div class="stat-lbl">${t('night')}</div><div class="stat-val">${stats.night}</div></div>
        <div class="stat-box"><div class="stat-lbl">${t('leaves')}</div><div class="stat-val">${stats.leaves}</div></div>
      </div>
    </div>

    <div class="actions">
      <button class="act-btn act-primary" onclick="dlPDF()">${t('pdf')}</button>
      <button class="act-btn act-ics" onclick="dlICS()">${t('ics')}</button>
      <button class="act-btn" onclick="shareS()">${t('share')}</button>
      <button class="act-btn" onclick="window.print()">${t('print')}</button>
    </div>
  `;
}

function chMonth(dir){
  const ci=months.indexOf(month),ni=ci-dir;
  if(ni>=0&&ni<months.length){month=months[ni];renderSchedule()}
}

function calcStats(s){
  const r={work:0,off:0,morning:0,afternoon:0,night:0,standby:0,leaves:0};
  s.forEach(d=>{
    if(d.shift_group==='Morning') r.morning++;
    else if(d.shift_group==='Afternoon') r.afternoon++;
    else if(d.shift_group==='Night') r.night++;
    else if(d.shift_group==='Off Day') r.off++;
    else if(d.shift_group==='Standby') r.standby++;
    else if(d.shift_group==='Annual Leave'||d.shift_group==='Sick Leave') r.leaves++;
  });
  r.work=r.morning+r.afternoon+r.night;
  return r;
}

function shiftClass(g){
  return{Morning:'s-morning',Afternoon:'s-afternoon',Night:'s-night',
         'Off Day':'s-off','Annual Leave':'s-leave','Sick Leave':'s-leave',
         Training:'s-training',Standby:'s-standby',Other:'s-other'}[g]||'s-other';
}
function isToday(y,m,d){
  const n=new Date();
  return n.getFullYear()===y&&n.getMonth()+1===m&&n.getDate()===d;
}
function esc(s){
  return String(s??'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

/* â”€â”€ ICS â”€â”€ */
function dlICS(){
  const sched=data.schedules[month];
  const [yr,mo]=month.split('-').map(Number);
  const pad=n=>String(n).padStart(2,'0');
  const lines=['BEGIN:VCALENDAR','VERSION:2.0','PRODID:-//MySchedule//EN','CALSCALE:GREGORIAN'];
  sched.forEach(d=>{
    const dt=`${yr}${pad(mo)}${pad(d.day)}`;
    const dtNext=new Date(yr,mo-1,d.day+1);
    const dtE=`${dtNext.getFullYear()}${pad(dtNext.getMonth()+1)}${pad(dtNext.getDate())}`;
    const sum=d.shift_code||d.shift_group;
    lines.push('BEGIN:VEVENT',
      `DTSTART;VALUE=DATE:${dt}`,
      `DTEND;VALUE=DATE:${dtE}`,
      `SUMMARY:${sum}`,
      `UID:${dt}-${data.id}-${d.day}@myschedule`,
      'END:VEVENT');
  });
  lines.push('END:VCALENDAR');
  const blob=new Blob([lines.join('\r\n')],{type:'text/calendar'});
  const a=document.createElement('a');
  a.href=URL.createObjectURL(blob);
  a.download=`schedule-${data.id}-${month}.ics`;
  a.click();URL.revokeObjectURL(a.href);
}

/* â”€â”€ PDF â”€â”€ Premium A4 Editorial Design â”€â”€ */
function dlPDF(){
  if(!window.jspdf){alert('PDF library loading, please try again.');return}
  const {jsPDF}=window.jspdf;

  const doc=new jsPDF({orientation:'portrait',unit:'mm',format:'a4'});
  const W=210, H=297, M=14;

  const sched=data.schedules[month];
  const [yr,mo]=month.split('-').map(Number);
  const mName=T.en.months[mo-1];
  const stats=calcStats(sched);

  // â”€â”€ Design tokens â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const NAVY  =[18, 24, 48];      // header bg
  const WHITE =[255,255,255];
  const INK   =[22, 28, 50];      // body text
  const SUB   =[100,110,130];     // secondary text
  const RULE  =[220,224,232];     // borders
  const CELL  =[252,253,255];     // off-white cell bg
  const EMPTY =[246,247,250];     // empty cell

  // shift palette â€” restrained, one tone per shift
  const S={
    Morning:     {bg:[255,249,235], fg:[154,98,12],  bar:[245,167,50]},
    Afternoon:   {bg:[255,246,238], fg:[174,74,20],  bar:[240,110,50]},
    Night:       {bg:[241,240,255], fg:[72,58,180],  bar:[100,85,220]},
    'Off Day':   {bg:[244,246,250], fg:[90,104,120], bar:[160,172,188]},
    'Annual Leave':{bg:[237,252,245],fg:[22,115,70], bar:[40,170,110]},
    'Sick Leave':{bg:[237,252,245], fg:[22,115,70],  bar:[40,170,110]},
    Training:    {bg:[237,247,255], fg:[30,90,190],  bar:[55,130,240]},
    Standby:     {bg:[255,240,250], fg:[155,40,110], bar:[210,70,150]},
    Other:       {bg:[246,247,250], fg:[110,118,130],bar:[170,178,190]}
  };

  const LNAMES={
    Morning:'Morning', Afternoon:'Afternoon', Night:'Night',
    'Off Day':'Day Off','Annual Leave':'Annual Leave','Sick Leave':'Sick Leave',
    Training:'Training',Standby:'Standby',Other:'Other'
  };

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  //  1. HEADER BAND  â€” full-width navy, elegant
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  const HDR=40;
  doc.setFillColor(...NAVY);
  doc.rect(0,0,W,HDR,'F');

  // subtle dot pattern top-right (decorative)
  doc.setFillColor(255,255,255);
  for(let r=0;r<3;r++) for(let c=0;c<5;c++){
    const opacity=0.04+c*0.015;
    doc.setFillColor(255,255,255);
    // just draw tiny faint circles
    if(c+r<5) doc.circle(W-M-c*7, 6+r*7, 0.8,'F');
  }

  // Month pill â€” top left inside header
  doc.setFillColor(255,255,255);
  doc.roundedRect(M,8,42,10,2,2,'F');
  doc.setTextColor(...NAVY);
  doc.setFontSize(9);doc.setFont(undefined,'bold');
  doc.text(`${mName.toUpperCase()}  ${yr}`, M+21, 14.8, {align:'center'});

  // Name â€” large, white
  doc.setTextColor(...WHITE);
  doc.setFontSize(20);doc.setFont(undefined,'bold');
  doc.text(String(data.name), M, 33);

  // Department + ID â€” right side
  doc.setFontSize(9);doc.setFont(undefined,'normal');
  doc.setTextColor(180,195,230);
  doc.text(`${data.department}`, W-M, 26, {align:'right'});
  doc.text(`ID  ${data.id}`, W-M, 33, {align:'right'});

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  //  2. STATS ROW  â€” 7 cards: work+off+morning+afternoon+night+standby+leaves
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  const stY=HDR+5;
  const stItems=[
    {l:'WORK',   v:stats.work,      accent:[55,130,240]},
    {l:'OFF',    v:stats.off,       accent:[160,172,188]},
    {l:'MORNING',v:stats.morning,   accent:[245,167,50]},
    {l:'AFTERNOON',v:stats.afternoon,accent:[240,110,50]},
    {l:'NIGHT',  v:stats.night,     accent:[100,85,220]},
    {l:'STANDBY',v:stats.standby,   accent:[210,70,150]},
    {l:'LEAVES', v:stats.leaves,    accent:[40,170,110]}
  ];
  const nSt=stItems.length;
  const stGap=2;
  const stW=(W-M*2-(nSt-1)*stGap)/nSt;
  const stH=20;

  stItems.forEach(({l,v,accent},i)=>{
    const sx=M+i*(stW+stGap);
    // white card with shadow-like border
    doc.setFillColor(...WHITE);
    doc.setDrawColor(...RULE);
    doc.setLineWidth(0.3);
    doc.roundedRect(sx,stY,stW,stH,2,2,'FD');
    // coloured top bar
    doc.setFillColor(...accent);
    doc.roundedRect(sx,stY,stW,2.5,1,1,'F');
    // number â€” big
    doc.setTextColor(...INK);
    doc.setFontSize(18);doc.setFont(undefined,'bold');
    doc.text(String(v),sx+stW/2,stY+13,{align:'center'});
    // label â€” tiny caps
    doc.setTextColor(...SUB);
    doc.setFontSize(5.5);doc.setFont(undefined,'bold');
    doc.text(l,sx+stW/2,stY+18.5,{align:'center'});
  });

  // thin rule under stats
  const ruleY=stY+stH+4;
  doc.setDrawColor(...RULE);
  doc.setLineWidth(0.3);
  doc.line(M,ruleY,W-M,ruleY);

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  //  3. CALENDAR  â€” takes most of the page
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  const calTop=ruleY+3;
  const dLabels=['Sunday','Monday','Tuesday','Wednesday','Thursday','Friday','Saturday'];
  const cW=(W-M*2)/7;
  const hH=9;

  // Header row
  doc.setFillColor(...NAVY);
  doc.rect(M,calTop,W-M*2,hH,'F');
  dLabels.forEach((d,i)=>{
    doc.setTextColor(...WHITE);
    doc.setFontSize(7.5);doc.setFont(undefined,'bold');
    doc.text(d, M+i*cW+cW/2, calTop+6, {align:'center'});
  });

  const firstDow=new Date(yr,mo-1,1).getDay();
  const dim=new Date(yr,mo,0).getDate();
  const todayD=new Date();
  const sameMonth=todayD.getFullYear()===yr&&todayD.getMonth()+1===mo;

  // count weeks used
  let nRows=0;
  {let d2=1;
   for(let w=0;w<6;w++){
     let any=false;
     for(let d=0;d<7;d++) if(!((w===0&&d<firstDow)||d2>dim)){any=true;d2++;}
     if(any) nRows++;
     if(d2>dim) break;
   }
  }

  // Footer reserve + legend space
  const footerH=14;
  const calBodyH=H-calTop-hH-footerH;
  const cH=Math.floor(calBodyH/nRows);

  let dc=1,row=0;

  for(let w=0;w<6;w++){
    for(let d=0;d<7;d++){
      const x=M+d*cW;
      const y=calTop+hH+row*cH;
      const isEmpty=(w===0&&d<firstDow)||dc>dim;

      if(isEmpty){
        doc.setFillColor(...EMPTY);
        doc.setDrawColor(...RULE);
        doc.setLineWidth(0.2);
        doc.rect(x,y,cW,cH,'FD');
      } else {
        const dd=sched.find(s=>s.day===dc);
        const isToday=sameMonth&&todayD.getDate()===dc;
        const sh=S[dd?.shift_group]||S.Other;

        // cell fill â€” very light tint of shift colour
        doc.setFillColor(...(dd ? sh.bg : WHITE));
        doc.setDrawColor(...RULE);
        doc.setLineWidth(0.2);
        doc.rect(x,y,cW,cH,'FD');

        // today ring
        if(isToday){
          doc.setDrawColor(43,89,255);
          doc.setLineWidth(0.7);
          doc.rect(x+0.35,y+0.35,cW-0.7,cH-0.7,'D');
          doc.setLineWidth(0.2);
        }

        // left colour bar
        if(dd){
          doc.setFillColor(...sh.bar);
          doc.rect(x,y,2.5,cH,'F');
        }

        // Day number â€” top right, big
        doc.setTextColor(...INK);
        doc.setFontSize(14);doc.setFont(undefined,'bold');
        doc.text(String(dc), x+cW-4, y+10, {align:'right'});

        // Shift label pill â€” centred, bottom area
        if(dd){
          const lbl=LNAMES[dd.shift_group]||dd.shift_group;
          const pillW=cW-10;
          const pillH=6.5;
          const pillX=x+5;
          const pillY=y+cH-pillH-3;

          doc.setFillColor(...sh.bar);
          doc.roundedRect(pillX,pillY,pillW,pillH,1.5,1.5,'F');

          doc.setTextColor(...WHITE);
          doc.setFontSize(6);doc.setFont(undefined,'bold');
          doc.text(lbl, pillX+pillW/2, pillY+4.5, {align:'center'});

          // shift code above pill, if exists
          if(dd.shift_code){
            doc.setTextColor(...sh.fg);
            doc.setFontSize(7.5);doc.setFont(undefined,'bold');
            doc.text(dd.shift_code, x+cW/2, pillY-1.5, {align:'center'});
          }
        }
        dc++;
      }
    }
    if(dc>dim) break;
    row++;
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  //  4. LEGEND + FOOTER
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  const legY=calTop+hH+row*cH+2;

  // legend rule
  doc.setDrawColor(...RULE);
  doc.setLineWidth(0.25);
  doc.line(M,legY,W-M,legY);

  const used=[...new Set(sched.map(s=>s.shift_group))];
  const legGap=(W-M*2)/used.length;
  used.forEach((g,i)=>{
    const sh2=S[g]||S.Other;
    const lx=M+i*legGap;
    doc.setFillColor(...sh2.bar);
    doc.roundedRect(lx, legY+2.5, 6, 3.5, 0.8, 0.8, 'F');
    doc.setTextColor(...SUB);
    doc.setFontSize(6.5);doc.setFont(undefined,'normal');
    doc.text(LNAMES[g]||g, lx+7.5, legY+5.5);
  });

  // footer line
  doc.setDrawColor(...RULE);
  doc.setLineWidth(0.25);
  doc.line(M,H-8,W-M,H-8);
  doc.setFillColor(...NAVY);
  doc.rect(M,H-8,6,3.5,'F'); // small navy accent
  doc.setTextColor(...SUB);
  doc.setFontSize(7);doc.setFont(undefined,'normal');
  doc.text(`Generated Â· My Schedule`, M+8, H-5.2);
  doc.text(`${mName} ${yr}  Â·  ${data.id}`, W-M, H-5.2, {align:'right'});

  doc.save(`schedule-${data.id}-${month}.pdf`);
}

/* â”€â”€ SHARE â”€â”€ */
function shareS(){
  const id=data.id;
  const base=location.pathname.includes('/roster-site/')?'/roster-site/':'/';
  const url=`${location.origin}${base}my-schedule/?emp=${encodeURIComponent(id)}`;
  if(navigator.share) navigator.share({title:'My Schedule',text:`Schedule: ${data.name}`,url});
  else{navigator.clipboard.writeText(url);alert('Link copied!');}
}

const p=new URLSearchParams(location.search).get('emp');
if(p){document.getElementById('empId').value=p;loadSchedule(p);}
</script>
</body>
</html>
