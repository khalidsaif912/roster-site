<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <title>My Schedule</title>
  <meta name="description" content="Employee schedule and roster viewer">
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    :root {
      --bg: #f1f5f9;
      --card: #ffffff;
      --foreground: #0c1a2e;
      --muted: #94a3b8;
      --border: #e2e8f0;
      --navy: #0c1a2e;
      --navy-light: #1e3a5f;
      --primary: #2563eb;
      --cyan: #06b6d4;
      --amber: #f59e0b;
      --orange: #f97316;
      --violet: #7c3aed;
      --pink: #ec4899;
      --emerald: #22c55e;
      --slate: #64748b;
      --r: 16px;
      --shadow: 0 4px 24px rgba(12,26,46,0.08);
    }

    body {
      font-family: 'Plus Jakarta Sans', system-ui, sans-serif;
      background: var(--bg);
      min-height: 100vh;
      color: var(--foreground);
      font-size: 14px;
    }
    body.rtl { direction: rtl; }

    /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê TOPBAR ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
    .topbar {
      background: linear-gradient(135deg, var(--navy) 0%, var(--navy-light) 100%);
      position: sticky; top: 0; z-index: 100;
      box-shadow: 0 2px 12px rgba(12,26,46,0.25);
    }
    .topbar-inner {
      max-width: 1300px; margin: 0 auto;
      padding: 0 16px; height: 56px;
      display: flex; align-items: center; justify-content: space-between;
    }
    .topbar-brand { display: flex; align-items: center; gap: 10px; }
    .topbar-icon {
      width: 36px; height: 36px; border-radius: 12px;
      background: linear-gradient(135deg, var(--primary), var(--cyan));
      display: flex; align-items: center; justify-content: center;
      font-size: 16px; box-shadow: 0 4px 14px rgba(37,99,235,0.35);
    }
    .topbar-title { color: #fff; font-size: 14px; font-weight: 800; letter-spacing: -0.3px; }
    .topbar-sub { color: rgba(255,255,255,0.5); font-size: 10px; font-weight: 600; margin-top: 1px; }
    .topbar-btn {
      background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.15);
      color: #fff; border-radius: 10px; padding: 6px 14px;
      font-size: 12px; font-weight: 700; cursor: pointer; transition: all 0.2s;
      font-family: inherit;
    }
    .topbar-btn:hover { background: rgba(255,255,255,0.2); }

    /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê SEARCH ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
    .search-section {
      background: linear-gradient(135deg, var(--navy) 0%, var(--navy-light) 100%);
      padding: 20px 16px 24px;
      display: flex; flex-direction: column; align-items: center;
      border-top: 1px solid rgba(255,255,255,0.05);
    }
    .search-wrap { max-width: 448px; width: 100%; }
    .search-label {
      color: rgba(255,255,255,0.6); font-size: 11px; font-weight: 700;
      letter-spacing: 0.8px; text-transform: uppercase; margin-bottom: 8px; display: block;
    }
    .search-row { display: flex; gap: 8px; }
    .search-input {
      flex: 1; padding: 10px 14px 10px 40px;
      border: 1.5px solid rgba(255,255,255,0.15); border-radius: 12px;
      font-size: 14px; direction: ltr;
      background: rgba(255,255,255,0.08); color: #fff;
      font-family: inherit; font-weight: 600; transition: all 0.2s;
    }
    .search-input::placeholder { color: rgba(255,255,255,0.3); font-weight: 400; }
    .search-input:focus {
      outline: none; border-color: var(--primary);
      background: rgba(255,255,255,0.12);
      box-shadow: 0 0 0 3px rgba(37,99,235,0.25);
    }
    .search-icon-wrap {
      position: relative;
    }
    .search-icon-wrap::before {
      content: 'üîç'; position: absolute; left: 14px; top: 50%; transform: translateY(-50%);
      font-size: 14px; opacity: 0.4; pointer-events: none;
    }
    .search-btn {
      padding: 10px 20px;
      background: linear-gradient(135deg, var(--primary), var(--cyan));
      color: #fff; border: none; border-radius: 12px;
      font-size: 13px; font-weight: 800; cursor: pointer;
      transition: all 0.2s; white-space: nowrap; font-family: inherit;
      box-shadow: 0 4px 14px rgba(37,99,235,0.35);
    }
    .search-btn:hover { transform: translateY(-1px); box-shadow: 0 6px 20px rgba(37,99,235,0.45); }

    /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê MAIN ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
    .main { max-width: 1300px; margin: 0 auto; padding: 24px 16px; display: flex; flex-direction: column; gap: 20px; }
    @media(min-width:640px) { .main, .topbar-inner { padding-left: 24px; padding-right: 24px; } }

    /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê EMPTY / LOADING ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
    .empty-state {
      text-align: center; padding: 64px 24px; color: var(--muted);
      background: var(--card); border-radius: var(--r); border: 1px solid var(--border);
    }
    .empty-icon { font-size: 48px; margin-bottom: 16px; opacity: 0.7; }
    .empty-state h3 { font-size: 18px; font-weight: 800; margin-bottom: 6px; color: var(--foreground); }
    .empty-state p { font-size: 13px; }
    .spinner {
      width: 36px; height: 36px; border: 3px solid var(--border);
      border-top-color: var(--primary); border-radius: 50%;
      animation: spin 1s linear infinite; margin: 0 auto 14px;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê EMPLOYEE HEADER ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
    .emp-header {
      background: linear-gradient(135deg, var(--navy), var(--navy-light));
      border-radius: var(--r); padding: 20px;
      display: flex; flex-direction: column; gap: 16px;
      box-shadow: var(--shadow);
    }
    @media(min-width:640px) {
      .emp-header { flex-direction: row; align-items: center; justify-content: space-between; }
    }
    .emp-left { display: flex; align-items: center; gap: 14px; min-width: 0; }
    .emp-avatar {
      width: 52px; height: 52px; border-radius: 16px; flex-shrink: 0;
      background: linear-gradient(135deg, var(--primary), var(--cyan));
      display: flex; align-items: center; justify-content: center;
      font-size: 20px; font-weight: 900; color: #fff;
      box-shadow: 0 4px 14px rgba(37,99,235,0.35);
    }
    .emp-name { font-size: 20px; font-weight: 900; color: #fff; letter-spacing: -0.3px; line-height: 1.2; }
    .emp-meta { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 6px; }
    .emp-badge {
      display: inline-flex; align-items: center; gap: 5px;
      background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.15);
      color: rgba(255,255,255,0.9); border-radius: 10px; padding: 3px 10px;
      font-size: 11px; font-weight: 700;
    }
    .month-nav { display: flex; align-items: center; gap: 8px; flex-shrink: 0; }
    .month-btn {
      width: 36px; height: 36px; border-radius: 12px;
      background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.15);
      color: #fff; font-size: 18px; cursor: pointer; transition: all 0.2s;
      display: flex; align-items: center; justify-content: center; font-family: inherit;
    }
    .month-btn:hover { background: rgba(255,255,255,0.2); }
    .month-btn:disabled { opacity: 0.3; cursor: default; }
    .month-select {
      background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2);
      color: #fff; border-radius: 12px; padding: 8px 14px;
      font-size: 12px; font-weight: 700; cursor: pointer;
      font-family: inherit; appearance: none; outline: none;
      min-width: 130px; text-align: center;
    }
    .month-select option { background: var(--navy); color: #fff; }

    /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê CONTENT GRID ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
    .content-grid { display: grid; grid-template-columns: 1fr; gap: 20px; align-items: start; }
    @media(min-width:1024px) { .content-grid { grid-template-columns: 1fr 320px; } }
    @media(min-width:1100px) { .content-grid { grid-template-columns: 1fr 340px; } }

    /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê CALENDAR ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
    .calendar-card {
      background: var(--card); border-radius: var(--r);
      border: 1px solid var(--border); box-shadow: var(--shadow); overflow: hidden;
    }
    .cal-head {
      display: grid; grid-template-columns: repeat(7,1fr);
      background: linear-gradient(135deg, var(--navy), var(--navy-light));
    }
    .cal-head div {
      padding: 10px 4px; text-align: center;
      font-weight: 800; color: rgba(255,255,255,0.7); font-size: 10px;
      letter-spacing: 0.5px;
    }
    @media(min-width:640px) { .cal-head div { font-size: 11px; } }
    .cal-body { display: grid; grid-template-columns: repeat(7,1fr); }
    .cal-day {
      border-right: 1px solid var(--border); border-bottom: 1px solid var(--border);
      padding: 6px 4px; background: var(--card); min-height: 80px;
      display: flex; flex-direction: column; align-items: center; gap: 3px;
      transition: background 0.15s; position: relative;
    }
    @media(min-width:640px) { .cal-day { min-height: 96px; padding: 8px 4px; } }
    .cal-day.empty { background: #f8fafc; }
    .cal-day.today { box-shadow: inset 0 0 0 2px var(--primary); }
    .d-num { font-size: 12px; font-weight: 900; color: var(--foreground); line-height: 1; }
    @media(min-width:640px) { .d-num { font-size: 13px; } }
    .d-icon { font-size: 18px; line-height: 1; }
    @media(min-width:640px) { .d-icon { font-size: 20px; } }
    .d-code {
      font-size: 10px; font-weight: 900;
      border-radius: 6px; padding: 2px 6px; letter-spacing: 0.3px;
    }
    @media(min-width:640px) { .d-code { font-size: 12px; } }
    .today .d-num { color: var(--primary); }

    /* Shift colors */
    .s-morning   { border-top: 3px solid var(--amber); background: #fffbf0; }
    .s-afternoon { border-top: 3px solid var(--orange); background: #fff8f5; }
    .s-night     { border-top: 3px solid var(--violet); background: #faf5ff; }
    .s-off       { border-top: 3px solid var(--slate); background: #f8fafc; }
    .s-leave     { border-top: 3px solid var(--emerald); background: #f0fdf4; }
    .s-training  { border-top: 3px solid var(--primary); background: #f0f9ff; }
    .s-standby   { border-top: 3px solid var(--pink); background: #fdf2f8; }
    .s-other     { border-top: 3px solid #9ca3af; }

    .s-morning   .d-code { color: #b45309; background: rgba(245,158,11,0.1); }
    .s-afternoon .d-code { color: #c2410c; background: rgba(249,115,22,0.1); }
    .s-night     .d-code { color: #5b21b6; background: rgba(124,58,237,0.1); }
    .s-off       .d-code { color: #475569; background: rgba(100,116,139,0.1); }
    .s-leave     .d-code { color: #15803d; background: rgba(34,197,94,0.1); }
    .s-training  .d-code { color: #1d4ed8; background: rgba(37,99,235,0.1); }
    .s-standby   .d-code { color: #be185d; background: rgba(236,72,153,0.1); }
    .s-other     .d-code { color: #6b7280; background: #f3f4f6; }

    /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê LEGEND ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
    .legend-card {
      background: var(--card); border-radius: var(--r); border: 1px solid var(--border);
      box-shadow: var(--shadow); padding: 16px; margin-top: 12px;
    }
    .legend-title {
      font-size: 10px; font-weight: 800; color: var(--muted);
      text-transform: uppercase; letter-spacing: 0.8px; margin-bottom: 10px;
    }
    .legend-grid { display: flex; flex-wrap: wrap; gap: 8px; }
    .leg-item { display: flex; align-items: center; gap: 6px; font-size: 11px; font-weight: 700; color: var(--slate); }
    .leg-dot { width: 10px; height: 10px; border-radius: 4px; flex-shrink: 0; }

    /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê SIDE PANEL ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
    .side-panel { display: none; flex-direction: column; gap: 16px; position: sticky; top: 76px; }
    @media(min-width:1024px) { .side-panel { display: flex; } }

    /* STATS */
    .stats-card {
      background: var(--card); border-radius: var(--r);
      border: 1px solid var(--border); box-shadow: var(--shadow); overflow: hidden;
    }
    .stats-header {
      padding: 12px 16px; border-bottom: 1px solid var(--border);
      background: linear-gradient(135deg, #f8fafc, #fff);
    }
    .stats-title {
      font-size: 10px; font-weight: 800; color: var(--muted);
      text-transform: uppercase; letter-spacing: 0.8px;
    }
    .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 1px; background: var(--border); }
    .stat-item {
      background: var(--card); padding: 14px 16px;
      display: flex; align-items: center; gap: 12px;
    }
    .stat-dot {
      width: 36px; height: 36px; border-radius: 12px;
      display: flex; align-items: center; justify-content: center;
      font-size: 16px; flex-shrink: 0; background: #f1f5f9;
    }
    .stat-val { font-size: 20px; font-weight: 900; color: var(--foreground); line-height: 1; }
    .stat-lbl { font-size: 10px; font-weight: 700; color: var(--muted); margin-top: 2px; }
    .stat-full { grid-column: 1 / -1; }

    /* ACTIONS */
    .actions-card {
      background: var(--card); border-radius: var(--r);
      border: 1px solid var(--border); box-shadow: var(--shadow); overflow: hidden;
    }
    .actions-header {
      padding: 12px 16px; border-bottom: 1px solid var(--border);
      background: linear-gradient(135deg, #f8fafc, #fff);
    }
    .actions-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 1px; background: var(--border); }
    .act-btn {
      background: var(--card); padding: 14px 12px;
      display: flex; flex-direction: column; align-items: center; gap: 6px;
      cursor: pointer; transition: all 0.2s; border: none; font-family: inherit;
    }
    .act-btn:hover { background: #f8fafc; }
    .act-icon { font-size: 20px; }
    .act-label { font-size: 10px; font-weight: 800; color: var(--muted); }
    .act-btn-full {
      grid-column: 1 / -1;
      background: linear-gradient(135deg, var(--primary), var(--cyan));
      color: #fff; padding: 14px; display: flex; align-items: center; justify-content: center; gap: 8px;
      cursor: pointer; border: none; font-family: inherit; font-size: 13px; font-weight: 800;
      transition: all 0.2s;
    }
    .act-btn-full:hover { filter: brightness(1.08); }

    /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê MOBILE STATS & ACTIONS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
    .mobile-section { display: block; margin-top: 16px; }
    @media(min-width:1024px) { .mobile-section { display: none; } }
    .stats-grid-mob { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; margin-top: 12px; }
    .stat-mob {
      background: var(--card); border: 1px solid var(--border);
      border-radius: 12px; padding: 10px 8px; text-align: center;
    }
    .stat-mob .val { font-size: 18px; font-weight: 900; color: var(--foreground); }
    .stat-mob .lbl { font-size: 9px; font-weight: 700; color: var(--muted); margin-top: 2px; }
    .actions-mob { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin-top: 12px; }
    @media(min-width:640px) { .actions-mob { grid-template-columns: repeat(5, 1fr); } }
    .act-mob {
      background: var(--card); border: 1.5px solid var(--border);
      border-radius: 12px; padding: 10px 6px; text-align: center;
      cursor: pointer; font-family: inherit; transition: all 0.2s;
    }
    .act-mob:hover { border-color: var(--primary); transform: translateY(-1px); }
    .act-mob .ico { font-size: 18px; }
    .act-mob .lbl { font-size: 10px; font-weight: 800; color: var(--muted); display: block; margin-top: 4px; }

    /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê SAVE POPUP ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
    .save-popup {
      position: fixed; bottom: 24px; left: 50%; transform: translateX(-50%);
      background: var(--navy); color: #fff; border-radius: var(--r);
      padding: 16px 20px; box-shadow: 0 12px 40px rgba(12,26,46,0.35);
      z-index: 9999; max-width: 340px; width: 92%;
      animation: slideUp 0.35s cubic-bezier(0.34,1.56,0.64,1);
      border: 1px solid rgba(255,255,255,0.1);
    }
    @keyframes slideUp {
      from { opacity: 0; transform: translateX(-50%) translateY(24px); }
      to { opacity: 1; transform: translateX(-50%) translateY(0); }
    }
    .save-popup p { font-size: 13px; font-weight: 600; margin-bottom: 12px; line-height: 1.5; }
    .save-popup-btns { display: flex; gap: 8px; }
    .popup-yes {
      flex: 1; padding: 9px;
      background: linear-gradient(135deg, var(--primary), var(--cyan));
      color: #fff; border: none; border-radius: 10px;
      font-size: 12px; font-weight: 800; cursor: pointer; font-family: inherit;
    }
    .popup-no {
      flex: 1; padding: 9px;
      background: rgba(255,255,255,0.08);
      color: rgba(255,255,255,0.8); border: 1px solid rgba(255,255,255,0.15);
      border-radius: 10px; font-size: 12px; font-weight: 700; cursor: pointer; font-family: inherit;
    }

    @media print {
      body { background: #fff; }
      .topbar, .search-section, .actions-card, .actions-mob, .topbar-btn { display: none !important; }
    }
  </style>
</head>
<body>

<!-- TOPBAR -->
<div class="topbar">
  <div class="topbar-inner">
    <div class="topbar-brand">
      <div class="topbar-icon">üìÖ</div>
      <div>
        <div class="topbar-title" id="ttl">My Schedule</div>
        <div class="topbar-sub" id="sub">Enter your Employee ID</div>
      </div>
    </div>
    <div style="display:flex;gap:8px">
      <button class="topbar-btn" onclick="toggleLang()" id="langBtn">ÿßŸÑÿπÿ±ÿ®Ÿäÿ©</button>
      <button class="topbar-btn" onclick="goBack()" id="backBtn">‚Üê Back</button>
    </div>
  </div>
</div>

<!-- SEARCH -->
<div class="search-section">
  <div class="search-wrap">
    <label class="search-label" id="search-lbl">Employee ID</label>
    <form class="search-row" id="searchForm">
      <div class="search-icon-wrap" style="flex:1;display:flex">
        <input type="text" class="search-input" id="empId" placeholder="e.g. 12345" pattern="[0-9]+" required style="width:100%">
      </div>
      <button type="submit" class="search-btn" id="sbtn">üìÖ View</button>
    </form>
  </div>
</div>

<!-- MAIN -->
<div class="main" id="area">
  <div class="empty-state">
    <div class="empty-icon">üîç</div>
    <h3 id="e1">Search your schedule</h3>
    <p id="e2">Enter your Employee ID above to view your monthly roster</p>
  </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script>
let data=null,month=null,months=[],lang='en';

const COLORS={
  Morning:      {strip:'#f59e0b',icon:'‚òÄÔ∏è',dot:'#f59e0b',bg:'#fffbf0'},
  Afternoon:    {strip:'#f97316',icon:'üå§Ô∏è',dot:'#f97316',bg:'#fff8f5'},
  Night:        {strip:'#7c3aed',icon:'üåô',dot:'#7c3aed',bg:'#faf5ff'},
  'Off Day':    {strip:'#94a3b8',icon:'üèñÔ∏è',dot:'#94a3b8',bg:'#f8fafc'},
  'Annual Leave':{strip:'#22c55e',icon:'üèñÔ∏è',dot:'#22c55e',bg:'#f0fdf4'},
  'Sick Leave': {strip:'#22c55e',icon:'ü§í',dot:'#22c55e',bg:'#f0fdf4'},
  Training:     {strip:'#2563eb',icon:'üìö',dot:'#2563eb',bg:'#f0f9ff'},
  Standby:      {strip:'#ec4899',icon:'üßç',dot:'#ec4899',bg:'#fdf2f8'},
  Other:        {strip:'#9ca3af',icon:'‚ùì',dot:'#9ca3af',bg:'#f9fafb'}
};

const STAT_META=[
  {k:'work',  icon:'üíº',label_en:'Work Days',label_ar:'ÿ£ŸäÿßŸÖ ÿπŸÖŸÑ'},
  {k:'off',   icon:'üõå',label_en:'Days Off',label_ar:'ÿ•ÿ¨ÿßÿ≤ÿßÿ™'},
  {k:'morning',icon:'‚òÄÔ∏è',label_en:'Morning',label_ar:'ÿµÿ®ÿßÿ≠Ÿä'},
  {k:'afternoon',icon:'üå§Ô∏è',label_en:'Afternoon',label_ar:'ŸÖÿ≥ÿßÿ¶Ÿä'},
  {k:'night', icon:'üåô',label_en:'Night',label_ar:'ŸÑŸäŸÑŸä'},
  {k:'standby',icon:'üßç',label_en:'Standby',label_ar:'ÿßÿ≠ÿ™Ÿäÿßÿ∑'},
  {k:'leaves',icon:'‚úàÔ∏è',label_en:'Leaves',label_ar:'ÿ•ÿ¨ÿßÿ≤ÿßÿ™ ÿ≥ŸÜŸàŸäÿ©'},
];

const T={
  en:{
    title:'My Schedule',sub:'Enter your Employee ID',searchLbl:'Employee ID',
    back:'‚Üê Back',langBtn:'ÿßŸÑÿπÿ±ÿ®Ÿäÿ©',
    ph:'e.g. 12345',sbtn:'üìÖ View',
    e1:'Search your schedule',e2:'Enter your Employee ID above to view your monthly roster',
    loading:'Loading...',notFound:'Employee not found',
    notFoundSub:'ID not in the system. Please check and try again.',
    statsTitle:'STATISTICS',actionsTitle:'ACTIONS',legendTitle:'LEGEND',
    pdf:'PDF',img:'Image',share:'Share',print:'Print',ics:'ICS',
    days:['Sun','Mon','Tue','Wed','Thu','Fri','Sat'],
    months:['January','February','March','April','May','June',
            'July','August','September','October','November','December'],
    legend:{Morning:'Morning',Afternoon:'Afternoon',Night:'Night',
            'Off Day':'Day Off','Annual Leave':'Annual Leave','Sick Leave':'Sick Leave',
            Training:'Training',Standby:'Standby',Other:'Other'}
  },
  ar:{
    title:'ÿ¨ÿØŸàŸÑŸä',sub:'ÿ£ÿØÿÆŸÑ ÿ±ŸÇŸÖŸÉ ÿßŸÑŸàÿ∏ŸäŸÅŸä',searchLbl:'ÿßŸÑÿ±ŸÇŸÖ ÿßŸÑŸàÿ∏ŸäŸÅŸä',
    back:'ÿ±ÿ¨Ÿàÿπ ‚Üê',langBtn:'English',
    ph:'ŸÖÿ´ÿßŸÑ: 12345',sbtn:'üìÖ ÿπÿ±ÿ∂',
    e1:'ÿßÿ®ÿ≠ÿ´ ÿπŸÜ ÿ¨ÿØŸàŸÑŸÉ',e2:'ÿ£ÿØÿÆŸÑ ÿ±ŸÇŸÖŸÉ ÿßŸÑŸàÿ∏ŸäŸÅŸä ÿ£ÿπŸÑÿßŸá ŸÑÿπÿ±ÿ∂ ŸÖŸÜÿßŸàÿ®ÿßÿ™ŸÉ ÿßŸÑÿ¥Ÿáÿ±Ÿäÿ©',
    loading:'ÿ¨ÿßÿ±Ÿä ÿßŸÑÿ™ÿ≠ŸÖŸäŸÑ...',notFound:'ŸÑŸÖ ŸäŸèÿπÿ´ÿ± ÿπŸÑŸâ ŸÖŸàÿ∏ŸÅ',
    notFoundSub:'ÿßŸÑÿ±ŸÇŸÖ ÿ∫Ÿäÿ± ŸÖŸàÿ¨ŸàÿØ ŸÅŸä ÿßŸÑŸÜÿ∏ÿßŸÖ. ÿ™ÿ≠ŸÇŸÇ Ÿàÿ£ÿπÿØ ÿßŸÑŸÖÿ≠ÿßŸàŸÑÿ©.',
    statsTitle:'ÿßŸÑÿ•ÿ≠ÿµÿßÿ¶Ÿäÿßÿ™',actionsTitle:'ÿßŸÑÿ•ÿ¨ÿ±ÿßÿ°ÿßÿ™',legendTitle:'ÿßŸÑÿØŸÑŸäŸÑ',
    pdf:'PDF',img:'ÿµŸàÿ±ÿ©',share:'ŸÖÿ¥ÿßÿ±ŸÉÿ©',print:'ÿ∑ÿ®ÿßÿπÿ©',ics:'ICS',
    days:['ÿßŸÑÿ£ÿ≠','ÿßŸÑÿßÿ´','ÿßŸÑÿ´ŸÑ','ÿßŸÑÿ£ÿ±','ÿßŸÑÿÆŸÖ','ÿßŸÑÿ¨ŸÖ','ÿßŸÑÿ≥ÿ®'],
    months:['ŸäŸÜÿßŸäÿ±','ŸÅÿ®ÿ±ÿßŸäÿ±','ŸÖÿßÿ±ÿ≥','ÿ£ÿ®ÿ±ŸäŸÑ','ŸÖÿßŸäŸà','ŸäŸàŸÜŸäŸà',
            'ŸäŸàŸÑŸäŸà','ÿ£ÿ∫ÿ≥ÿ∑ÿ≥','ÿ≥ÿ®ÿ™ŸÖÿ®ÿ±','ÿ£ŸÉÿ™Ÿàÿ®ÿ±','ŸÜŸàŸÅŸÖÿ®ÿ±','ÿØŸäÿ≥ŸÖÿ®ÿ±'],
    legend:{Morning:'ÿµÿ®ÿßÿ≠Ÿä',Afternoon:'ŸÖÿ≥ÿßÿ¶Ÿä',Night:'ŸÑŸäŸÑŸä',
            'Off Day':'ÿ•ÿ¨ÿßÿ≤ÿ©','Annual Leave':'ÿ≥ŸÜŸàŸäÿ©','Sick Leave':'ŸÖÿ±ÿ∂Ÿäÿ©',
            Training:'ÿ™ÿØÿ±Ÿäÿ®',Standby:'ÿßÿ≠ÿ™Ÿäÿßÿ∑Ÿä',Other:'ÿ£ÿÆÿ±Ÿâ'}
  }
};

function t(k){return T[lang][k];}

function applyLangUI(){
  document.documentElement.lang=lang;
  document.documentElement.dir=lang==='ar'?'rtl':'ltr';
  document.body.classList.toggle('rtl',lang==='ar');
  document.getElementById('ttl').textContent=t('title');
  document.getElementById('sub').textContent=t('sub');
  document.getElementById('search-lbl').textContent=t('searchLbl');
  document.getElementById('langBtn').textContent=t('langBtn');
  document.getElementById('backBtn').textContent=t('back');
  document.getElementById('empId').placeholder=t('ph');
  document.getElementById('sbtn').textContent=t('sbtn');
  const e1=document.getElementById('e1'),e2=document.getElementById('e2');
  if(e1)e1.textContent=t('e1');
  if(e2)e2.textContent=t('e2');
  if(data)renderSchedule();
}
function toggleLang(){lang=lang==='en'?'ar':'en';applyLangUI();}

function goBack(){
  const base=location.pathname.includes('/roster-site/')?'/roster-site/':'/';
  if(document.referrer&&document.referrer.includes(location.host))history.back();
  else location.href=base;
}

document.getElementById('searchForm').addEventListener('submit',async e=>{
  e.preventDefault();
  const id=document.getElementById('empId').value.trim();
  if(id)await loadSchedule(id);
});

async function loadSchedule(id){
  document.getElementById('area').innerHTML=
    `<div class="empty-state"><div class="spinner"></div><p>${t('loading')}</p></div>`;
  try{
    const res=await fetch(`../schedules/${id}.json`);
    if(!res.ok)throw new Error();
    data=await res.json();
    months=Object.keys(data.schedules).sort();
    if(!months.length)throw new Error();
    const savedId=localStorage.getItem('savedEmpId');
    if(!savedId)showSavePopup(id,data.name);
    const _now=new Date();
    const _cur=_now.getFullYear()+'-'+String(_now.getMonth()+1).padStart(2,'0');
    month=months.includes(_cur)?_cur:months[months.length-1];
    renderSchedule();
  }catch{
    document.getElementById('area').innerHTML=`
      <div class="empty-state">
        <div class="empty-icon">‚ùå</div>
        <h3>${t('notFound')}</h3>
        <p>${t('notFoundSub')}</p>
      </div>`;
  }
}

function showSavePopup(id,name){
  var old=document.getElementById('savePopup');if(old)old.remove();
  var firstName=name?name.split(' ')[0]:id;
  var popup=document.createElement('div');
  popup.className='save-popup';popup.id='savePopup';
  popup.innerHTML=`
    <p>üëã ŸáŸÑ ÿ£ŸÜÿ™ <strong>${firstName}</strong>ÿü<br>
    <span style="font-weight:400;font-size:12px;opacity:.75;">ÿßÿ≠ŸÅÿ∏ ÿ±ŸÇŸÖŸÉ ŸÑÿ™ÿµŸÑ ŸÑÿ¨ÿØŸàŸÑŸÉ ÿ®ÿ≥ÿ±ÿπÿ© ŸÅŸä ÿßŸÑŸÖÿ±ÿßÿ™ ÿßŸÑŸÇÿßÿØŸÖÿ©</span></p>
    <div class="save-popup-btns">
      <button class="popup-yes" onclick="confirmSave('${id}')">‚úÖ ŸÜÿπŸÖÿå ÿßÿ≠ŸÅÿ∏ ÿ±ŸÇŸÖŸä</button>
      <button class="popup-no" onclick="dismissPopup()">ŸÅŸÇÿ∑ ÿ£ÿ™ÿµŸÅÿ≠</button>
    </div>`;
  document.body.appendChild(popup);
  setTimeout(()=>dismissPopup(),10000);
}
function confirmSave(id){localStorage.setItem('savedEmpId',id);dismissPopup();renderSchedule();}
function dismissPopup(){var p=document.getElementById('savePopup');if(p)p.remove();}
function changeMyId(){
  if(confirm(lang==='ar'?'ŸáŸÑ ÿ™ÿ±ŸäÿØ ÿ™ÿ∫ŸäŸäÿ± ÿ±ŸÇŸÖŸÉ ÿßŸÑŸÖÿ≠ŸÅŸàÿ∏ÿü':'Change your saved Employee ID?')){
    localStorage.removeItem('savedEmpId');renderSchedule();
  }
}
function setAsMyId(){if(data&&data.id){localStorage.setItem('savedEmpId',data.id);renderSchedule();}}

function renderSchedule(){
  const sched=data.schedules[month];
  const [yr,mo]=month.split('-').map(Number);
  const ci=months.indexOf(month);
  const hasPrev=ci>0,hasNext=ci<months.length-1;
  const firstDow=new Date(yr,mo-1,1).getDay();
  const dim=new Date(yr,mo,0).getDate();
  const stats=calcStats(sched);
  const savedId=localStorage.getItem('savedEmpId');
  const isMyId=savedId===data.id;

  let cells='',dc=1;
  const nowD=new Date();
  for(let w=0;w<6;w++){
    for(let d=0;d<7;d++){
      if((w===0&&d<firstDow)||dc>dim){
        cells+='<div class="cal-day empty"></div>';
      }else{
        const dd=sched.find(s=>s.day===dc);
        const sc=dd?shiftClass(dd.shift_group):'';
        const icon=dd?(COLORS[dd.shift_group]?.icon||''):'';
        const code=dd&&dd.shift_code?'<div class="d-code">'+esc(dd.shift_code)+'</div>':'';
        const todayCls=(nowD.getFullYear()===yr&&nowD.getMonth()+1===mo&&nowD.getDate()===dc)?' today':'';
        cells+='<div class="cal-day '+sc+todayCls+'">'
          +'<div class="d-num">'+dc+'</div>'
          +(icon?'<div class="d-icon">'+icon+'</div>':'')+code+'</div>';
        dc++;
      }
    }
    if(dc>dim)break;
  }

  const dayHdr=T[lang].days.map(d=>'<div>'+d+'</div>').join('');
  const monthOpts=months.map(m=>{
    const p=m.split('-').map(Number);
    const label=T[lang].months[p[1]-1]+' '+p[0];
    return '<option value="'+m+'"'+(m===month?' selected':'')+'>'+label+'</option>';
  }).join('');

  const used=[...new Set(sched.map(s=>s.shift_group))];
  const legHTML=used.map(g=>{
    const c=COLORS[g];if(!c)return '';
    return '<span class="leg-item"><span class="leg-dot" style="background:'+c.dot+'"></span>'+(T[lang].legend[g]||g)+'</span>';
  }).join('');

  const statsItemsHTML=STAT_META.map(m=>`
    <div class="stat-item${m.k==='work'?' stat-full':''}">
      <div class="stat-dot">${m.icon}</div>
      <div>
        <div class="stat-val">${stats[m.k]}</div>
        <div class="stat-lbl">${lang==='ar'?m.label_ar:m.label_en}</div>
      </div>
    </div>`).join('');

  const changeBtn=isMyId
    ?`<button class="emp-badge" style="cursor:pointer;margin-top:6px" onclick="changeMyId()">‚úèÔ∏è ${lang==='ar'?'ÿ™ÿ∫ŸäŸäÿ± ÿ±ŸÇŸÖŸä':'Change My ID'}</button>`
    :(!savedId?'':`<button class="emp-badge" style="cursor:pointer;margin-top:6px" onclick="setAsMyId()">üìå ${lang==='ar'?'ÿßÿ≠ŸÅÿ∏ ŸÉÿ±ŸÇŸÖŸä':'Set as My ID'}</button>`);

  const initials=(data.name||'?').split(' ').slice(0,2).map(w=>w[0]).join('').toUpperCase();

  const mobStats=STAT_META.map(m=>`
    <div class="stat-mob">
      <div class="val">${stats[m.k]}</div>
      <div class="lbl">${lang==='ar'?m.label_ar:m.label_en}</div>
    </div>`).join('');

  document.getElementById('area').innerHTML=`
    <div class="emp-header">
      <div class="emp-left">
        <div class="emp-avatar">${initials}</div>
        <div style="min-width:0">
          <div class="emp-name">${esc(data.name)}</div>
          <div class="emp-meta">
            <span class="emp-badge">üìã ${esc(data.department)}</span>
            <span class="emp-badge">üÜî ${esc(data.id)}</span>
          </div>
          ${changeBtn}
        </div>
      </div>
      <div class="month-nav">
        <button class="month-btn" onclick="chMonth(-1)" ${!hasPrev?'disabled':''}>&#8249;</button>
        <select class="month-select" onchange="jumpMonth(this.value)">${monthOpts}</select>
        <button class="month-btn" onclick="chMonth(1)" ${!hasNext?'disabled':''}>&#8250;</button>
      </div>
    </div>

    <div class="content-grid">
      <div>
        <div class="calendar-card">
          <div class="cal-head">${dayHdr}</div>
          <div class="cal-body">${cells}</div>
        </div>
        <div class="legend-card">
          <div class="legend-title">${t('legendTitle')}</div>
          <div class="legend-grid">${legHTML}</div>
        </div>

        <div class="mobile-section">
          <div class="stats-title" style="font-size:10px;font-weight:800;color:var(--muted);text-transform:uppercase;letter-spacing:.8px">${t('statsTitle')}</div>
          <div class="stats-grid-mob">${mobStats}</div>
          <div class="actions-mob" style="margin-top:12px">
            <button class="act-mob" onclick="dlPDF()"><span class="ico">üì•</span><span class="lbl">${t('pdf')}</span></button>
            <button class="act-mob" onclick="dlICS()"><span class="ico">üìÜ</span><span class="lbl">${t('ics')}</span></button>
            <button class="act-mob" onclick="dlIMG()"><span class="ico">üñºÔ∏è</span><span class="lbl">${t('img')}</span></button>
            <button class="act-mob" onclick="shareS()"><span class="ico">üîó</span><span class="lbl">${t('share')}</span></button>
            <button class="act-mob" onclick="window.print()"><span class="ico">üñ®Ô∏è</span><span class="lbl">${t('print')}</span></button>
          </div>
        </div>
      </div>

      <div class="side-panel">
        <div class="stats-card">
          <div class="stats-header"><div class="stats-title">${t('statsTitle')}</div></div>
          <div class="stats-grid">${statsItemsHTML}</div>
        </div>
        <div class="actions-card">
          <div class="actions-header"><div class="stats-title">${t('actionsTitle')}</div></div>
          <div class="actions-grid">
            <button class="act-btn act-btn-full" onclick="dlPDF()">üì• ${t('pdf')}</button>
            <button class="act-btn" onclick="dlICS()"><span class="act-icon">üìÜ</span><span class="act-label">${t('ics')}</span></button>
            <button class="act-btn" onclick="dlIMG()"><span class="act-icon">üñºÔ∏è</span><span class="act-label">${t('img')}</span></button>
            <button class="act-btn" onclick="shareS()"><span class="act-icon">üîó</span><span class="act-label">${t('share')}</span></button>
            <button class="act-btn" onclick="window.print()"><span class="act-icon">üñ®Ô∏è</span><span class="act-label">${t('print')}</span></button>
          </div>
        </div>
      </div>
    </div>`;
}

function chMonth(dir){const ci=months.indexOf(month),ni=ci+dir;if(ni>=0&&ni<months.length){month=months[ni];renderSchedule();}}
function jumpMonth(val){if(months.includes(val)){month=val;renderSchedule();}}

function calcStats(s){
  const r={work:0,off:0,morning:0,afternoon:0,night:0,standby:0,leaves:0};
  s.forEach(d=>{
    if(d.shift_group==='Morning')r.morning++;
    else if(d.shift_group==='Afternoon')r.afternoon++;
    else if(d.shift_group==='Night')r.night++;
    else if(d.shift_group==='Off Day')r.off++;
    else if(d.shift_group==='Standby')r.standby++;
    else if(d.shift_group==='Annual Leave'||d.shift_group==='Sick Leave')r.leaves++;
  });
  r.work=r.morning+r.afternoon+r.night;
  return r;
}
function shiftClass(g){
  return{Morning:'s-morning',Afternoon:'s-afternoon',Night:'s-night',
         'Off Day':'s-off','Annual Leave':'s-leave','Sick Leave':'s-leave',
         Training:'s-training',Standby:'s-standby',Other:'s-other'}[g]||'s-other';
}
function esc(s){return String(s??'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');}

/* ‚îÄ‚îÄ SHARE ‚îÄ‚îÄ */
function shareS(){
  const url=location.href;
  if(navigator.share){navigator.share({title:t('title'),url});}
  else{navigator.clipboard.writeText(url).then(()=>alert(lang==='ar'?'ÿ™ŸÖ ŸÜÿ≥ÿÆ ÿßŸÑÿ±ÿßÿ®ÿ∑':'Link copied!'));}
}

/* ‚îÄ‚îÄ IMAGE DOWNLOAD ‚îÄ‚îÄ */
async function dlIMG(){
  if(!window.html2canvas){alert('Image library loading, please try again.');return}
  const calEl=document.querySelector('.calendar-card');
  if(!calEl){alert('No calendar to capture.');return}
  const [yr,mo]=month.split('-').map(Number);
  const mName=T[lang].months[mo-1]+' '+yr;
  const stats=calcStats(data.schedules[month]);
  const used=[...new Set(data.schedules[month].map(s=>s.shift_group))];
  const W=Math.max(calEl.offsetWidth,700);
  const wrap=document.createElement('div');
  wrap.style.cssText=`position:fixed;left:-9999px;top:0;background:#f1f5f9;border-radius:20px;overflow:hidden;font-family:'Plus Jakarta Sans',system-ui,sans-serif;width:${W+40}px;`;
  const initials=(data.name||'?').split(' ').slice(0,2).map(w=>w[0]).join('').toUpperCase();
  const hdr=document.createElement('div');
  hdr.style.cssText='background:linear-gradient(135deg,#0c1a2e,#1e3a5f);padding:18px 22px;display:flex;align-items:center;justify-content:space-between;';
  hdr.innerHTML=`
    <div style="display:flex;align-items:center;gap:14px">
      <div style="width:48px;height:48px;border-radius:16px;background:linear-gradient(135deg,#2563eb,#06b6d4);display:flex;align-items:center;justify-content:center;color:#fff;font-size:18px;font-weight:900;flex-shrink:0">${initials}</div>
      <div>
        <div style="color:#fff;font-size:20px;font-weight:900;letter-spacing:-.3px">${esc(data.name)}</div>
        <div style="color:rgba(255,255,255,.65);font-size:11px;font-weight:600;margin-top:3px">üìã ${esc(data.department)} ¬∑ üÜî ${esc(data.id)}</div>
      </div>
    </div>
    <div style="background:rgba(255,255,255,.12);border:1px solid rgba(255,255,255,.2);color:#fff;border-radius:12px;padding:8px 16px;font-size:13px;font-weight:800">${mName}</div>`;
  wrap.appendChild(hdr);
  const calWrap=document.createElement('div');
  calWrap.style.cssText='background:#fff;padding:16px 20px 12px;';
  const calClone=calEl.cloneNode(true);
  calClone.style.cssText='border-radius:12px;overflow:hidden;border:1px solid #e2e8f0;';
  calClone.querySelectorAll('.cal-day').forEach(d=>{d.style.minHeight='90px';});
  calWrap.appendChild(calClone);wrap.appendChild(calWrap);
  const legWrap=document.createElement('div');
  legWrap.style.cssText='background:#fff;padding:0 20px 14px;display:flex;flex-wrap:wrap;gap:8px;';
  used.forEach(g=>{
    const c=COLORS[g];if(!c)return;
    const item=document.createElement('span');
    item.style.cssText='display:inline-flex;align-items:center;gap:5px;font-size:11px;font-weight:700;color:#64748b;';
    item.innerHTML=`<span style="width:10px;height:10px;border-radius:3px;background:${c.dot};display:inline-block"></span>${T['en'].legend[g]||g}`;
    legWrap.appendChild(item);
  });
  wrap.appendChild(legWrap);
  const STAT_LABELS=[
    {k:'work',icon:'üíº',label:'Work Days',c:'#2563eb'},
    {k:'off',icon:'üèñÔ∏è',label:'Days Off',c:'#64748b'},
    {k:'morning',icon:'‚òÄÔ∏è',label:'Morning',c:'#b45309'},
    {k:'afternoon',icon:'üå§Ô∏è',label:'Afternoon',c:'#c2410c'},
    {k:'night',icon:'üåô',label:'Night',c:'#5b21b6'},
    {k:'standby',icon:'üßç',label:'Standby',c:'#be185d'},
    {k:'leaves',icon:'üèñÔ∏è',label:'Leaves',c:'#15803d'},
  ];
  const stWrap=document.createElement('div');
  stWrap.style.cssText='background:#f1f5f9;padding:14px 20px 18px;';
  const stTitle=document.createElement('div');
  stTitle.style.cssText='font-size:9px;font-weight:800;color:#94a3b8;text-transform:uppercase;letter-spacing:.8px;margin-bottom:10px';
  stTitle.textContent='STATISTICS';stWrap.appendChild(stTitle);
  const stRow=document.createElement('div');stRow.style.cssText='display:flex;gap:8px;';
  STAT_LABELS.forEach(m=>{
    const box=document.createElement('div');
    box.style.cssText=`flex:1;background:#fff;border:1px solid #e2e8f0;border-radius:12px;padding:10px 6px;text-align:center;border-top:3px solid ${m.c};`;
    box.innerHTML=`<div style="font-size:22px;font-weight:900;color:${m.c};line-height:1">${stats[m.k]}</div><div style="font-size:8px;font-weight:700;color:#94a3b8;margin-top:4px">${m.label}</div>`;
    stRow.appendChild(box);
  });
  stWrap.appendChild(stRow);wrap.appendChild(stWrap);
  document.body.appendChild(wrap);
  try{
    const canvas=await html2canvas(wrap,{scale:3,useCORS:true,backgroundColor:'#f1f5f9',logging:false});
    const link=document.createElement('a');link.download=`schedule-${data.id}-${month}.png`;link.href=canvas.toDataURL('image/png');link.click();
  }catch(e){alert('Image capture failed: '+e.message);}
  finally{document.body.removeChild(wrap);}
}

/* ‚îÄ‚îÄ ICS ‚îÄ‚îÄ */
function dlICS(){
  const sched=data.schedules[month];
  const [yr,mo]=month.split('-').map(Number);
  const pad=n=>String(n).padStart(2,'0');
  const lines=['BEGIN:VCALENDAR','VERSION:2.0','PRODID:-//MySchedule//EN','CALSCALE:GREGORIAN'];
  sched.forEach(d=>{
    const dt=`${yr}${pad(mo)}${pad(d.day)}`;
    const dtNext=new Date(yr,mo-1,d.day+1);
    const dtE=`${dtNext.getFullYear()}${pad(dtNext.getMonth()+1)}${pad(dtNext.getDate())}`;
    const sum=d.shift_code||d.shift_group;
    lines.push('BEGIN:VEVENT',`DTSTART;VALUE=DATE:${dt}`,`DTEND;VALUE=DATE:${dtE}`,`SUMMARY:${sum}`,`UID:${dt}-${data.id}-${d.day}@myschedule`,'END:VEVENT');
  });
  lines.push('END:VCALENDAR');
  const blob=new Blob([lines.join('\r\n')],{type:'text/calendar'});
  const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download=`schedule-${data.id}-${month}.ics`;a.click();URL.revokeObjectURL(a.href);
}

/* ‚îÄ‚îÄ PDF ‚îÄ‚îÄ */
function dlPDF(){
  if(!window.jspdf){alert('PDF library loading, please try again.');return}
  const {jsPDF}=window.jspdf;
  const doc=new jsPDF({orientation:'portrait',unit:'mm',format:'a4'});
  const W=210,H=297,ML=7,MR=7;
  const sched=data.schedules[month];
  const [yr,mo]=month.split('-').map(Number);
  const mName=T.en.months[mo-1];
  const stats=calcStats(sched);
  const SC={Morning:{fg:[200,90,0],bg:[255,243,224]},Afternoon:{fg:[180,45,5],bg:[255,235,218]},Night:{fg:[20,55,190],bg:[224,230,255]},'Off Day':{fg:[85,95,115],bg:[238,240,245]},'Annual Leave':{fg:[10,125,60],bg:[218,248,230]},'Sick Leave':{fg:[10,125,60],bg:[218,248,230]},Training:{fg:[10,85,190],bg:[218,238,255]},Standby:{fg:[148,10,110],bg:[250,218,242]},Other:{fg:[90,100,115],bg:[240,241,246]}};
  const FALLBACK={'Off Day':'OFF','Annual Leave':'LV','Sick Leave':'SL',Training:'TR',Standby:'ST',Other:'‚Äî'};
  const NAVY=[12,26,46],WHITE=[255,255,255],RULE=[195,202,215],EMPTY=[244,245,249],DIM=[105,115,132];
  const HDR_H=30,CAL_HDR=9,STATS_H=42,FOOT_H=10,GAP1=3,GAP2=4;
  const CAL_TOP=HDR_H+GAP1,STATS_TOP=H-FOOT_H-GAP2-STATS_H,CAL_BOT=STATS_TOP-GAP2,CAL_BODY=CAL_BOT-CAL_TOP-CAL_HDR;
  const firstDow=new Date(yr,mo-1,1).getDay(),dim=new Date(yr,mo,0).getDate();
  const now=new Date(),thisMo=now.getFullYear()===yr&&now.getMonth()+1===mo;
  let nRows=0;{let d2=1;for(let w=0;w<6;w++){let any=false;for(let d=0;d<7;d++)if(!((w===0&&d<firstDow)||d2>dim)){any=true;d2++;}if(any)nRows++;if(d2>dim)break;}}
  const CH=Math.floor(CAL_BODY/nRows),CW=(W-ML-MR)/7;
  doc.setFillColor(...NAVY);doc.rect(0,0,W,HDR_H,'F');
  doc.setTextColor(...WHITE);doc.setFontSize(17);doc.setFont(undefined,'bold');doc.text(String(data.name),ML,13);
  doc.setFontSize(8.5);doc.setFont(undefined,'normal');doc.setTextColor(165,188,235);doc.text(`${data.department}   ¬∑   ID: ${data.id}`,ML,21);
  doc.setFillColor(...WHITE);doc.roundedRect(W-MR-55,9,55,14,3,3,'F');doc.setTextColor(...NAVY);doc.setFontSize(10.5);doc.setFont(undefined,'bold');doc.text(`${mName}  ${yr}`,W-MR-27.5,18,{align:'center'});
  doc.setFillColor(...NAVY);doc.rect(ML,CAL_TOP,W-ML-MR,CAL_HDR,'F');
  const DAYS=['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
  doc.setFontSize(7);doc.setFont(undefined,'bold');doc.setTextColor(180,195,220);
  DAYS.forEach((d,i)=>{doc.text(d,ML+CW*i+CW/2,CAL_TOP+6.2,{align:'center'});});
  let dc=1;const bodyTop=CAL_TOP+CAL_HDR;
  for(let w=0;w<6;w++){
    for(let d=0;d<7;d++){
      const x=ML+CW*d,y=bodyTop+CH*w;
      if((w===0&&d<firstDow)||dc>dim){doc.setFillColor(...EMPTY);doc.rect(x,y,CW,CH,'F');doc.setDrawColor(...RULE);doc.rect(x,y,CW,CH);}
      else{
        const dd=sched.find(s=>s.day===dc);const sc=dd?SC[dd.shift_group]:null;
        doc.setFillColor(sc?sc.bg[0]:255,sc?sc.bg[1]:255,sc?sc.bg[2]:255);doc.rect(x,y,CW,CH,'F');
        if(sc){doc.setFillColor(sc.fg[0],sc.fg[1],sc.fg[2]);doc.rect(x,y,CW,2.2,'F');}
        doc.setDrawColor(...RULE);doc.rect(x,y,CW,CH);
        if(thisMo&&now.getDate()===dc){doc.setDrawColor(37,99,235);doc.setLineWidth(.6);doc.rect(x+.3,y+.3,CW-.6,CH-.6);doc.setLineWidth(.2);}
        doc.setFontSize(9);doc.setFont(undefined,'bold');doc.setTextColor(...NAVY);doc.text(String(dc),x+CW/2,y+6.5,{align:'center'});
        if(dd){
          const code=dd.shift_code||(FALLBACK[dd.shift_group]||'');
          if(code&&sc){
            const tw=doc.getTextWidth(code)+3;
            doc.setFillColor(sc.bg[0],sc.bg[1],sc.bg[2]);
            doc.roundedRect(x+CW/2-tw/2,y+CH-8,tw,5.5,1.2,1.2,'F');
            doc.setFontSize(7);doc.setFont(undefined,'bold');doc.setTextColor(sc.fg[0],sc.fg[1],sc.fg[2]);
            doc.text(code,x+CW/2,y+CH-4,{align:'center'});
          }
        }
        dc++;
      }
    }
    if(dc>dim)break;
  }
  // Stats bar
  doc.setFillColor(241,245,249);doc.rect(ML,STATS_TOP,W-ML-MR,STATS_H,'F');
  doc.setDrawColor(...RULE);doc.rect(ML,STATS_TOP,W-ML-MR,STATS_H);
  doc.setFontSize(6.5);doc.setFont(undefined,'bold');doc.setTextColor(148,163,184);
  doc.text('STATISTICS',ML+4,STATS_TOP+5);
  const STAT_LABELS=[{k:'work',label:'Work',c:[37,99,235]},{k:'off',label:'Off',c:[100,116,139]},{k:'morning',label:'Morning',c:[180,83,9]},{k:'afternoon',label:'Afternoon',c:[194,65,12]},{k:'night',label:'Night',c:[91,33,182]},{k:'standby',label:'Standby',c:[190,24,93]},{k:'leaves',label:'Leaves',c:[21,128,61]}];
  const bw=(W-ML-MR-8)/STAT_LABELS.length-3;
  STAT_LABELS.forEach((m,i)=>{
    const bx=ML+4+i*(bw+3),by=STATS_TOP+9;
    doc.setFillColor(255,255,255);doc.roundedRect(bx,by,bw,STATS_H-14,2,2,'F');
    doc.setDrawColor(...RULE);doc.roundedRect(bx,by,bw,STATS_H-14,2,2);
    doc.setFillColor(m.c[0],m.c[1],m.c[2]);doc.rect(bx,by,bw,2,'F');
    doc.setFontSize(14);doc.setFont(undefined,'bold');doc.setTextColor(m.c[0],m.c[1],m.c[2]);
    doc.text(String(stats[m.k]),bx+bw/2,by+14,{align:'center'});
    doc.setFontSize(5.5);doc.setTextColor(148,163,184);doc.text(m.label,bx+bw/2,by+20,{align:'center'});
  });
  // Footer
  doc.setFontSize(7);doc.setTextColor(180,190,200);
  doc.text('Generated by My Schedule',W/2,H-4,{align:'center'});
  doc.save(`schedule-${data.id}-${month}.pdf`);
}

// Auto-load saved ID
window.addEventListener('DOMContentLoaded',()=>{
  const saved=localStorage.getItem('savedEmpId');
  if(saved){document.getElementById('empId').value=saved;loadSchedule(saved);}
});
</script>
</body>
</html>
