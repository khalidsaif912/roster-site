/**
 * Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù†Ø¸Ø§Ù…
 */
const CONFIG = {
  SHEET_PENDING: 'Pending',
  SHEET_SUBS: 'Subscribers',
  APP_NAME: 'Duty Roster',
  PRIMARY_COLOR: '#1a73e8' // Ø§Ù„Ù„ÙˆÙ† Ø§Ù„Ø£Ø²Ø±Ù‚ Ø§Ù„Ø®Ø§Øµ Ø¨Ù…ÙˆÙ‚Ø¹Ùƒ
};

/**
 * 1. Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ù…Ù† Ø§Ù„ÙÙˆØ±Ù… (Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ Ø§Ù„Ø£ÙˆÙ„ÙŠ) Ù…Ø¹ Ù…Ù†Ø¹ Ø§Ù„ØªÙƒØ±Ø§Ø±
 */
function doPost(e) {
  try {
    const email = String(e.parameter.email || '').trim().toLowerCase();
    const mode  = String(e.parameter.mode  || '').trim(); 
    const lang  = String(e.parameter.lang  || 'ar').trim();
    const isAr  = (lang === 'ar');

    if (!email) return ContentService.createTextOutput("Missing email");

    const ss = SpreadsheetApp.getActiveSpreadsheet();
    const pendingSheet = ss.getSheetByName(CONFIG.SHEET_PENDING);
    const subsSheet = ss.getSheetByName(CONFIG.SHEET_SUBS);

    if (!pendingSheet || !subsSheet) return ContentService.createTextOutput("Error: Sheets not found");

    // --- ÙØ­Øµ Ø§Ù„ØªÙƒØ±Ø§Ø± ---
    
    // 1. Ù‡Ù„ Ù‡Ùˆ Ù…Ø´ØªØ±Ùƒ Ø¨Ø§Ù„ÙØ¹Ù„ØŸ
    if (isEmailInSheet(subsSheet, email)) {
      return showMessagePage(
        isAr ? "Ø£Ù†Øª Ù…Ø´ØªØ±Ùƒ Ø¨Ø§Ù„ÙØ¹Ù„!" : "Already Subscribed!",
        isAr ? "Ù‡Ø°Ø§ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ Ù…Ø³Ø¬Ù„ Ù„Ø¯ÙŠÙ†Ø§ Ù…Ø³Ø¨Ù‚Ø§Ù‹ ÙÙŠ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø´ØªØ±ÙƒÙŠÙ†." : "This email is already in our subscriber list.",
        "âœ…", 
        isAr
      );
    }

    // 2. Ù‡Ù„ Ø£Ø±Ø³Ù„ Ø·Ù„Ø¨Ø§Ù‹ ÙˆÙ‡Ùˆ Ù‚ÙŠØ¯ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±ØŸ
    if (isEmailInSheet(pendingSheet, email)) {
      return showMessagePage(
        isAr ? "Ø§Ù„Ø·Ù„Ø¨ Ù‚ÙŠØ¯ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±" : "Request Pending",
        isAr ? "Ù„Ù‚Ø¯ Ø£Ø±Ø³Ù„Ù†Ø§ Ù„Ùƒ Ø±Ø§Ø¨Ø· Ø§Ù„ØªØ£ÙƒÙŠØ¯ Ù…Ø³Ø¨Ù‚Ø§Ù‹ØŒ ÙŠØ±Ø¬Ù‰ ÙØ­Øµ Ø¨Ø±ÙŠØ¯Ùƒ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ Ù„ØªÙØ¹ÙŠÙ„Ù‡." : "We already sent a confirmation link. Please check your email to activate it.",
        "â³",
        isAr
      );
    }

    // --- Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù…ÙƒØ±Ø±Ø§Ù‹ØŒ Ù†ÙƒÙ…Ù„ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª ---
    const token = Utilities.getUuid();
    pendingSheet.appendRow([email, mode, lang, token, new Date()]);

    const confirmUrl = ScriptApp.getService().getUrl() + '?action=confirm&token=' + encodeURIComponent(token);
    const subject = isAr ? `ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ â€” ${CONFIG.APP_NAME}` : `Confirm Subscription â€” ${CONFIG.APP_NAME}`;
    
    const htmlEmail = isAr 
      ? `<div dir="rtl" style="font-family: sans-serif; text-align: center; border: 1px solid #eee; padding: 20px; border-radius: 10px;">
          <h2 style="color: #1a73e8;">Ù…Ø±Ø­Ø¨Ø§Ù‹ØŒ</h2>
          <p>Ø´ÙƒØ±Ø§Ù‹ Ù„Ø§Ù‡ØªÙ…Ø§Ù…Ùƒ Ø¨Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ ÙÙŠ <b>${CONFIG.APP_NAME}</b>.</p>
          <p>ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Ø§Ù„Ø²Ø± Ø£Ø¯Ù†Ø§Ù‡ Ù„ØªÙØ¹ÙŠÙ„ Ø§Ø´ØªØ±Ø§ÙƒÙƒ ÙˆØªØ£ÙƒÙŠØ¯ Ù‡ÙˆÙŠØªÙƒ:</p>
          <br>
          <a href="${confirmUrl}" style="background-color: #4CAF50; color: white; padding: 12px 25px; text-decoration: none; border-radius: 8px; display: inline-block; font-weight: bold;">ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ Ø§Ù„Ø¢Ù†</a>
          <p style="margin-top: 25px; color: #888; font-size: 0.8em;">Ø¥Ø°Ø§ Ù„Ù… ØªØ·Ù„Ø¨ Ù‡Ø°Ø§ Ø§Ù„Ø§Ø´ØªØ±Ø§ÙƒØŒ ÙŠÙ…ÙƒÙ†Ùƒ ØªØ¬Ø§Ù‡Ù„ Ù‡Ø°Ø§ Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„.</p>
         </div>`
      : `<div style="font-family: sans-serif; text-align: center; border: 1px solid #eee; padding: 20px; border-radius: 10px;">
          <h2 style="color: #1a73e8;">Hello,</h2>
          <p>Thank you for subscribing to <b>${CONFIG.APP_NAME}</b>.</p>
          <p>Please click the button below to confirm your email and activate your subscription:</p>
          <br>
          <a href="${confirmUrl}" style="background-color: #4CAF50; color: white; padding: 12px 25px; text-decoration: none; border-radius: 8px; display: inline-block; font-weight: bold;">Confirm Subscription</a>
          <p style="margin-top: 25px; color: #888; font-size: 0.8em;">If you didn't request this, you can safely ignore this email.</p>
         </div>`;

    MailApp.sendEmail({ to: email, subject: subject, htmlBody: htmlEmail });

    return showMessagePage(
      isAr ? "Ø®Ø·ÙˆØ© ÙˆØ§Ø­Ø¯Ø© Ù…ØªØ¨Ù‚ÙŠØ©!" : "One more step!",
      isAr ? "ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø±Ø§Ø¨Ø· Ø§Ù„ØªØ£ÙƒÙŠØ¯ Ø¥Ù„Ù‰ Ø¨Ø±ÙŠØ¯Ùƒ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø¶ØºØ· Ø¹Ù„ÙŠÙ‡ Ù„ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ." : "A confirmation link has been sent to your email. Please click it to activate.",
      "ğŸ“§",
      isAr
    );

  } catch (err) {
    return ContentService.createTextOutput("ERROR: " + err.toString());
  }
}

/**
 * 2. Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ Ø·Ù„Ø¨Ø§Øª Ø§Ù„ØªØ£ÙƒÙŠØ¯ (Ø¹Ù†Ø¯ Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Ø§Ù„Ø±Ø§Ø¨Ø· ÙÙŠ Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„)
 */
function doGet(e) {
  try {
    const action = e.parameter.action;
    const token = e.parameter.token;

    if (action === 'confirm' && token) {
      const ss = SpreadsheetApp.getActiveSpreadsheet();
      const pendingSheet = ss.getSheetByName(CONFIG.SHEET_PENDING);
      const subsSheet = ss.getSheetByName(CONFIG.SHEET_SUBS);
      const data = pendingSheet.getDataRange().getValues();
      
      for (let i = 0; i < data.length; i++) {
        if (data[i][3] === token) {
          subsSheet.appendRow([data[i][0], data[i][1], data[i][2], new Date()]);
          pendingSheet.deleteRow(i + 1);
          return showMessagePage("ØªÙ… Ø§Ù„ØªØ£ÙƒÙŠØ¯!", "Ø´ÙƒØ±Ø§Ù‹ Ù„ÙƒØŒ ØªÙ… ØªÙØ¹ÙŠÙ„ Ø§Ø´ØªØ±Ø§ÙƒÙƒ Ø¨Ù†Ø¬Ø§Ø­ ÙÙŠ Duty Roster.", "âœ”", true);
        }
      }
      return ContentService.createTextOutput("Invalid or expired token.");
    }
    return ContentService.createTextOutput("Invalid Request");
  } catch (err) {
    return ContentService.createTextOutput("Error: " + err.toString());
  }
}

/**
 * Ø¯Ø§Ù„Ø© Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„
 */
function isEmailInSheet(sheet, email) {
  const data = sheet.getDataRange().getValues();
  for (let i = 0; i < data.length; i++) {
    if (data[i][0].toString().toLowerCase() === email) return true;
  }
  return false;
}

/**
 * Ø¯Ø§Ù„Ø© Ù…ÙˆØ­Ø¯Ø© Ù„Ø¹Ø±Ø¶ Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ø§Ø³ØªØ¬Ø§Ø¨Ø© Ø¨ØªØµÙ…ÙŠÙ… Ø§Ù„Ù…ÙˆÙ‚Ø¹
 */
function showMessagePage(title, message, icon, isAr) {
  const html = `
    <div dir="${isAr ? 'rtl' : 'ltr'}" style="font-family: sans-serif; text-align: center; padding: 50px; background-color: #f0f4f8; min-height: 100vh; display: flex; justify-content: center; align-items: center;">
      <div style="background: white; padding: 40px; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.05); max-width: 450px; width: 90%;">
        <div style="font-size: 60px; margin-bottom: 20px;">${icon}</div>
        <h2 style="color: ${CONFIG.PRIMARY_COLOR}; margin-bottom: 15px;">${title}</h2>
        <p style="color: #444; line-height: 1.6; font-size: 17px;">${message}</p>
        <div style="margin-top: 30px; border-top: 1px solid #eee; padding-top: 20px;">
          <p style="font-size: 13px; color: #999;">${CONFIG.APP_NAME} &copy; 2024</p>
        </div>
      </div>
    </div>
  `;
  return HtmlService.createHtmlOutput(html).setTitle(title);
}